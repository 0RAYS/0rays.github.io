import{j as e,m as u,a as c,B as N,d as de,A as pe,R as he,r as D,h as fe,u as ge,t as p,L as je}from"./index-DU2x9rtW.js";import{A as ve}from"./AdminPagination-CGmyMxdO.js";import{a as ye,b as be}from"./contest-kBLQoMUR.js";import{a as Ne,g as we}from"./team-BI1GzLgo.js";import"./IconChevronsRight-DmPitXL-.js";function M({title:t,value:l,valueColor:a="text-neutral-50",subTitle:m,subValue:g,subValueColor:h,showProgress:d,progressValue:j}){return e.jsxs("div",{className:"border border-neutral-300 rounded-md bg-black/30 backdrop-blur-[2px] p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-neutral-400 text-sm",children:t}),e.jsx("div",{className:`font-mono text-xl ${a}`,children:l})]}),m&&g&&e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("div",{className:"text-neutral-400 text-sm",children:m}),e.jsx("div",{className:`font-mono text-xl ${h}`,children:g})]}),d&&e.jsx("div",{className:"h-2 bg-neutral-700 rounded-full overflow-hidden mt-2",children:e.jsx(u.div,{className:"h-full bg-geek-400",initial:{width:0},animate:{width:`${j}%`},transition:{duration:1}})})]})}function re({notifications:t}){return t=t.slice().reverse().slice(0,3),t.length===3&&(t[2]={title:"...",type:"info"}),e.jsxs(u.div,{className:`border border-neutral-300 rounded-md bg-black/30 backdrop-blur-[2px] p-4\r
                overflow-hidden`,initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("span",{className:"text-neutral-400 text-sm",children:"Notifications"})}),e.jsx("div",{className:"space-y-2",children:t.map((l,a)=>e.jsxs(u.div,{className:"text-sm",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:a*.1},children:[e.jsx("span",{className:`
                          ${l.type==="success"?"text-green-400":l.type==="info"?"text-geek-400":"text-yellow-400"}
                      `,children:"•"}),e.jsx("span",{className:"text-neutral-300 ml-2",children:l.title})]},a))})]})}function Ce({contestStatus:t,notifications:l,onStatusExpired:a}){const[m,g]=c.useState(0);c.useEffect(()=>{let d;const j=()=>{const k=Date.parse(t.endTime),C=Date.now(),T=k-C;return T<=0?(g(0),t.status==="upcoming"?a==null||a("active"):t.status==="active"&&(a==null||a("ended")),!1):(g(Math.floor(T/1e3)),!0)};return j(),d=setInterval(()=>{j()},1e3),()=>{clearInterval(d)}},[t.status,t.startTime,t.endTime]);const h=d=>{const j=Math.floor(d/3600),k=Math.floor(d%3600/60),C=d%60;return`${String(j).padStart(2,"0")}:${String(k).padStart(2,"0")}:${String(C).padStart(2,"0")}`};return t.status==="upcoming"?e.jsxs("div",{className:"grid grid-cols-4 gap-6",children:[e.jsxs(u.div,{className:"col-span-3 grid grid-cols-3 gap-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx(M,{title:"Contest Status",value:"UPCOMING",valueColor:"text-yellow-400"}),e.jsx(M,{title:"Start Time",value:new Date(t.startTime).toLocaleString(),valueColor:"text-neutral-50"}),e.jsx(M,{title:"Time Until Start",value:h(m),valueColor:"text-neutral-50"})]}),e.jsx(re,{notifications:l})]}):t.status==="ended"?e.jsx(e.Fragment,{}):e.jsxs("div",{className:"grid grid-cols-4 gap-6",children:[e.jsxs(u.div,{className:"col-span-3 grid grid-cols-3 gap-6",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx(M,{title:"Time Remaining",value:h(m),valueColor:"text-neutral-50"}),e.jsx(M,{title:"Team Score",value:t.team.score.toLocaleString(),valueColor:"text-geek-400",subTitle:"Rank",subValue:`#${t.team.rank}`,subValueColor:"text-yellow-400"}),e.jsx(M,{title:"Flags Solved",value:`${t.team.solved}/${t.totalChallenges}`,valueColor:"text-neutral-50",showProgress:!0,progressValue:t.team.solved/t.totalChallenges*100})]}),e.jsx(re,{notifications:l})]})}function ie({categories:t,selectedCategory:l,onCategoryChange:a,challenges:m,onChallengeClick:g,teamInfo:h,totalCount:d=0,currentPage:j=1,pageSize:k=12,onPageChange:C}){const[T,x]=c.useState(null);return e.jsxs(u.div,{className:"border border-neutral-300 rounded-md bg-black/30 backdrop-blur-[2px] p-8",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("div",{className:"flex gap-4",children:t.map(n=>e.jsx(N,{variant:l===n?"primary":"ghost",size:"sm",className:`min-w-0 px-4 py-1 ${l===n?"":"text-neutral-400 hover:text-neutral-200"}`,onClick:()=>a(n),children:n},n))}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex -space-x-2",children:h.members.map((n,w)=>e.jsx("div",{className:"w-8 h-8 rounded-lg border-2 border-black bg-neutral-700 bg-cover bg-center",style:{backgroundImage:`url(${n})`}},w))}),e.jsx("span",{className:"text-neutral-400 font-mono",children:h.name})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:m.map((n,w)=>e.jsxs(u.div,{className:`p-4 border rounded-md transition-all duration-200 cursor-pointer backdrop-blur-none
                ${n.solved?"border-geek-400/50 bg-geek-400/5 hover:bg-geek-400/10":"border-neutral-300/30 bg-black/30 hover:bg-black/50"}
                ${T===w?"scale-[1.02]":""}`,onMouseEnter:()=>x(w),onMouseLeave:()=>x(null),whileHover:{y:-2},onClick:()=>g(n),children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-geek-400 font-mono",children:n.category}),e.jsx("h3",{className:"text-neutral-50 font-mono",children:n.title}),e.jsxs("span",{className:"text-yellow-400 font-mono text-sm",children:[n.points," pts"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-neutral-400 text-sm",children:"Solves:"}),e.jsx("span",{className:"text-neutral-50 font-mono",children:n.solves})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:n.tags&&n.tags.map((v,S)=>e.jsx("span",{className:`
                      px-2 py-0.5 rounded 
                      text-xs font-mono
                      border backdrop-blur-none
                      ${n.solved?"border-geek-400/30 bg-geek-400/20 text-neutral-50":"border-neutral-600 bg-neutral-900 text-neutral-300"}
                    `,children:v},S))}),e.jsxs("div",{className:"flex items-center gap-3",children:[!n.isInitialized&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-black/50 border border-yellow-400/30 rounded",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-yellow-400 animate-pulse"}),e.jsx("span",{className:"text-yellow-400 text-xs font-mono",children:"Not Initialized"})]}),n.hasInstance&&n.instanceRunning&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-black/50 border border-green-400/30 rounded",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"}),e.jsx("span",{className:"text-green-400 text-xs font-mono",children:"Instance Running"})]}),n.solved&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-black/50 border border-geek-400/30 rounded",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-geek-400"}),e.jsx("span",{className:"text-geek-400 text-xs font-mono",children:"Solved"})]})]})]})]},n.id))}),d>0&&e.jsx("div",{className:"mt-6 flex justify-center",children:e.jsx(ve,{total:Math.ceil(d/k),current:j,onChange:C,showTotal:!0,totalItems:d})})]})}function ke({startTime:t,joined:l,onJoin:a}){const[m,g]=c.useState({days:0,hours:0,minutes:0,seconds:0});return c.useEffect(()=>{const h=()=>{const j=new Date(t)-new Date;j>0&&g({days:Math.floor(j/864e5),hours:Math.floor(j/36e5%24),minutes:Math.floor(j/1e3/60%60),seconds:Math.floor(j/1e3%60)})};h();const d=setInterval(h,1e3);return()=>clearInterval(d)},[t]),e.jsx(u.div,{className:"border border-neutral-300 rounded-md bg-black/30 backdrop-blur-[2px] p-8",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl text-neutral-50 font-mono mb-2",children:"Contest Starting In"}),e.jsx("p",{className:"text-neutral-400",children:"Get ready for the challenge"})]}),e.jsx("div",{className:"flex gap-8",children:[{label:"DAYS",value:m.days},{label:"HOURS",value:m.hours},{label:"MINUTES",value:m.minutes},{label:"SECONDS",value:m.seconds}].map((h,d)=>e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-[100px] h-[100px] border border-geek-400 rounded-md \r
                                bg-black/50 flex items-center justify-center\r
                                text-4xl text-geek-400 font-mono\r
                                shadow-[0_0_15px_rgba(89,126,247,0.1)]`,children:String(h.value).padStart(2,"0")}),e.jsx("span",{className:"mt-2 text-neutral-400 text-sm font-mono",children:h.label})]},d))}),e.jsx("div",{className:"flex flex-col items-center space-y-4",children:l?e.jsx("div",{className:`px-8 py-2 border border-green-400 rounded-md\r
                            bg-green-400/5 text-green-400 font-mono\r
                            shadow-[0_0_15px_rgba(74,222,128,0.1)]`,children:"JOINED"}):e.jsx(N,{variant:"primary",size:"lg",className:"!text-lg",onClick:a,children:"JOIN NOW"})})]})})}function Se({contestInfo:t,onViewScoreboard:l,onUploadWriteup:a,onViewChallenges:m,writeups:g=[]}){const[h,d]=c.useState(!1),j=n=>n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`,k=n=>new Date(n).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),C=n=>{n.preventDefault(),d(!0)},T=()=>{d(!1)},x=n=>{n.preventDefault(),d(!1),n.dataTransfer.files&&n.dataTransfer.files[0]&&a(n.dataTransfer.files[0])};return e.jsx("div",{className:"w-full max-w-[800px] mx-auto",children:e.jsxs(u.div,{className:"border border-neutral-300 rounded-md bg-black/30 backdrop-blur-[2px] p-8",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"text-center space-y-4 mb-8",children:[e.jsx(u.div,{className:`w-16 h-16 mx-auto border-2 border-yellow-400 rounded-full\r
                            flex items-center justify-center`,initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring"},children:e.jsx("span",{className:"text-3xl",children:"🏆"})}),e.jsxs("h2",{className:"text-2xl font-mono text-neutral-50",children:["Contest ",e.jsx("span",{className:"text-yellow-400",children:"Completed"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs(u.div,{className:"p-4 border border-neutral-300/30 rounded-md text-center",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:[e.jsx("div",{className:"text-neutral-400 text-sm mb-1",children:"Duration"}),e.jsx("div",{className:"text-neutral-50 font-mono",children:(t==null?void 0:t.duration)||"24h"})]}),e.jsxs(u.div,{className:"p-4 border border-neutral-300/30 rounded-md text-center",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},children:[e.jsx("div",{className:"text-neutral-400 text-sm mb-1",children:"Teams"}),e.jsx("div",{className:"text-neutral-50 font-mono",children:(t==null?void 0:t.totalTeams)||"256"})]}),e.jsxs(u.div,{className:"p-4 border border-neutral-300/30 rounded-md text-center",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("div",{className:"text-neutral-400 text-sm mb-1",children:"Challenges"}),e.jsx("div",{className:"text-neutral-50 font-mono",children:(t==null?void 0:t.totalChallenges)||"30"})]})]}),e.jsxs(u.div,{className:"p-6 border border-geek-400 rounded-md bg-geek-400/5",initial:{opacity:0},animate:{opacity:1},transition:{delay:.6},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("span",{className:"text-neutral-50 font-mono",children:"Your Team Performance"}),e.jsxs("span",{className:"text-geek-400 font-mono",children:["#",(t==null?void 0:t.teamRank)||"1"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-neutral-400 text-sm mb-1",children:"Score"}),e.jsx("div",{className:"text-geek-400 font-mono text-xl",children:(t==null?void 0:t.teamScore)||"0"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-neutral-400 text-sm mb-1",children:"Solved"}),e.jsxs("div",{className:"text-neutral-50 font-mono text-xl",children:[(t==null?void 0:t.teamSolved)||"0","/",(t==null?void 0:t.totalChallenges)||"0"]})]})]})]}),e.jsxs(u.div,{className:"space-y-4",initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},children:[e.jsx("div",{className:"text-neutral-50 font-mono text-lg",children:"Writeups"}),e.jsxs(u.div,{className:`border-2 border-dashed rounded-md p-6 text-center cursor-pointer transition-all duration-300
                ${h?"border-yellow-400 bg-yellow-400/10":"border-neutral-400 hover:border-yellow-400 hover:bg-yellow-400/5"}`,whileHover:{scale:1.01},onDragOver:C,onDragLeave:T,onDrop:x,onClick:()=>document.getElementById("writeup-upload").click(),children:[e.jsx("input",{id:"writeup-upload",type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:n=>{n.target.files&&n.target.files[0]&&(a(n.target.files[0]),n.target.value="")}}),e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-2",children:[e.jsx("span",{className:"text-2xl",children:"📄"}),e.jsx("span",{className:"text-neutral-300 font-mono",children:"Drag and drop files or click here to upload your writeups"}),e.jsx("span",{className:"text-neutral-400 text-sm",children:"Supports PDF, DOC, DOCX"})]})]}),g.length>0&&e.jsxs(u.div,{className:"mt-4 border border-neutral-300/30 rounded-md overflow-hidden",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},transition:{delay:.8},children:[e.jsx("div",{className:"p-3 bg-neutral-800/50 border-b border-neutral-300/30",children:e.jsx("div",{className:"text-neutral-300 font-mono text-sm",children:"Uploaded Writeups"})}),e.jsx("div",{className:"divide-y divide-neutral-300/20",children:g.map(n=>e.jsx("div",{className:"p-3 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"text-xl",children:n.suffix===".pdf"?"📕":n.suffix===".docx"||n.suffix===".doc"?"📘":"📄"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-neutral-50 font-mono text-sm",children:n.filename}),e.jsxs("div",{className:"text-neutral-400 text-xs flex space-x-3",children:[e.jsx("span",{children:j(n.size)}),e.jsx("span",{children:"•"}),e.jsx("span",{children:k(n.date)})]})]})]})},n.id))})]})]}),e.jsxs(u.div,{className:"flex justify-center gap-4 pt-4",initial:{opacity:0},animate:{opacity:1},transition:{delay:.9},children:[e.jsx(N,{variant:"outline",size:"lg",onClick:m,children:"VIEW CHALLENGES"}),e.jsx(N,{variant:"primary",size:"lg",onClick:l,children:"VIEW FINAL SCOREBOARD"})]})]})]})})}const me=he.memo(({hint:t,index:l})=>{const[a,m]=c.useState(!1);return e.jsxs(u.div,{className:`
                border border-neutral-300/30 rounded-md overflow-hidden
                transition-colors duration-200
                ${a?"bg-neutral-900/50":"bg-black/20"}
            `,children:[e.jsxs("div",{className:"flex items-center justify-between p-2 cursor-pointer hover:bg-neutral-800/30",onClick:()=>m(!a),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-geek-400 font-mono text-sm",children:["#",l+1]}),e.jsx("span",{className:"text-neutral-300 font-mono text-sm",children:a?"Hide Hint":"Show Hint"})]}),e.jsx(u.span,{className:"text-neutral-400 text-[10px]",animate:{rotate:a?180:0},transition:{duration:.2},children:"▼"})]}),e.jsx(u.div,{initial:!1,animate:{height:a?"auto":0,opacity:a?1:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"p-3 border-t border-neutral-300/10",children:e.jsx("span",{className:"text-neutral-400 font-mono text-sm",children:t})})})]})});me.displayName="HintItem";function le({challenge:t,contest:l,isOpen:a,onClose:m,onInitialize:g,onReset:h,onLaunchInstance:d,onExtendInstance:j,onDestroyInstance:k,onSubmitFlag:C,onDownloadAttachment:T}){var H;const[x,n]=c.useState({initializing:!1,resetting:!1,launching:!1,extending:!1,destroying:!1,submitting:!1}),[w,v]=c.useState(null),[S,I]=c.useState(""),[$,P]=c.useState([]),[se,B]=c.useState({}),[_,V]=c.useState(0),z=c.useRef(null),{addMessageHandler:q}=de();c.useEffect(()=>q(i=>{(i.type==="start_victim"||i.type==="stop_victim")&&n(o=>({...o,launching:!1})),i.type==="generate_attachment"&&(n(o=>({...o,resetting:!1})),n(o=>({...o,initializing:!1})))}),[q]),c.useEffect(()=>{t!=null&&t.instanceTimeLeft&&V(t.instanceTimeLeft)},[t==null?void 0:t.instanceTimeLeft]),c.useEffect(()=>{if(!(!t||!a)&&!(!t.instanceRunning||!_))return z.current&&clearInterval(z.current),z.current=setInterval(()=>{V(i=>i<=0?(clearInterval(z.current),0):i-1)},1e3),()=>{z.current&&clearInterval(z.current)}},[t==null?void 0:t.instanceRunning,a]);const Y=i=>{i=Math.floor(i);const o=Math.floor(i/3600),y=Math.floor(i%3600/60),L=Math.floor(i%60);return`${o.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}:${L.toString().padStart(2,"0")}`},R=async(i,o,...y)=>{v(null);try{await o(...y)&&n(L=>({...L,[i]:!0}))}catch(L){v(L.message)}finally{i==="launching"||(i==="resetting"||i==="initializing")&&t.hasAttachments||n(L=>({...L,[i]:!1}))}},J=()=>{R("initializing",g,t.id)},X=()=>{R("resetting",h,t.id)},ae=()=>{R("launching",d,t.id)},F=()=>{R("extending",j,t.id)},K=()=>{R("destroying",k,t.id)},A=i=>{P(o=>o.includes(i)?o.filter(y=>y!==i):[...o,i])},G=async i=>{if(i.preventDefault(),t.type==="question"){if($.length===0){v("请至少选择一个选项");return}const o=$.join(",");n(y=>({...y,submitting:!0})),v(null);try{(await C(t.id,o)).success&&(P([]),m())}catch(y){v(y.message)}finally{n(y=>({...y,submitting:!1}))}}else{if(!S.trim())return;n(o=>({...o,submitting:!0})),v(null);try{(await C(t.id,S)).success&&(I(""),m())}catch(o){v(o.message)}finally{n(o=>({...o,submitting:!1}))}}},U=i=>{navigator.clipboard.writeText(i),B(o=>({...o,[i]:!0})),setTimeout(()=>{B(o=>({...o,[i]:!1}))},2e3)},Z=()=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`w-2 h-2 rounded-full ${t.instanceRunning?"bg-green-400":"bg-neutral-400"}`}),e.jsx("span",{className:"text-neutral-50 font-mono text-sm",children:t.instanceRunning?"RUNNING":"NOT RUNNING"})]}),t.instanceRunning&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-neutral-400 text-sm",children:"Time:"}),e.jsx("span",{className:"text-yellow-400 font-mono text-sm",children:Y(_)})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:t.instanceRunning?e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"primary",size:"sm",onClick:F,disabled:x.extending,className:"border-yellow-400 text-yellow-400 hover:bg-yellow-400/10",children:x.extending?"EXTENDING...":"EXTEND TIME"}),e.jsx(N,{variant:"danger",size:"sm",onClick:K,disabled:x.destroying,children:x.destroying?"DESTROYING...":"DESTROY"})]}):e.jsx(N,{variant:"primary",size:"sm",onClick:ae,disabled:x.launching,loading:x.launching,className:x.launching?"border-yellow-400 text-yellow-400":"",children:x.launching?"LAUNCHING...":"LAUNCH INSTANCE"})})]}),t.instanceRunning&&e.jsx("div",{className:"h-1.5 bg-neutral-700 rounded-full overflow-hidden",children:e.jsx(u.div,{className:"h-full bg-yellow-400",initial:{width:0},animate:{width:`${_/t.instanceDuration*100}%`},transition:{duration:.5}})}),t.instanceRunning&&t.instanceIP&&e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-between p-2 bg-neutral-900 rounded-md",children:e.jsx("span",{className:"text-neutral-400 text-xs",children:"Address:"})}),t.instanceIP.map((i,o)=>e.jsxs("div",{className:"flex justify-between p-1.5",children:[e.jsx("span",{className:"font-mono text-neutral-50 text-sm",onClick:()=>U(i),children:i}),e.jsx(N,{variant:"ghost",size:"icon",className:"!text-neutral-400 hover:!text-geek-400",onClick:()=>U(i),children:se[i]?"✓":"📋"})]},o))]})]}),Q=()=>!t.hints||t.hints.length===0?null:e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("h3",{className:"text-neutral-400 font-mono text-sm",children:"Hints"}),e.jsx("div",{className:"space-y-2",children:t.hints.map((i,o)=>e.jsx(me,{hint:i,index:o},`hint-${t.id}-${o}`))})]}),ee=()=>t.type!=="question"||!t.options||t.options.length===0?null:e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("h3",{className:"text-neutral-400 font-mono text-sm",children:"选择答案"}),e.jsx("div",{className:"space-y-2",children:t.options.map((i,o)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border border-neutral-300/30 rounded-md hover:border-geek-400/50 transition-colors duration-200 cursor-pointer",onClick:()=>A(i.rand_id),children:[e.jsx("div",{className:"flex items-center justify-center w-5 h-5 border-2 border-neutral-400 rounded transition-colors duration-200",children:$.includes(i.rand_id)&&e.jsx("div",{className:"w-2 h-2 bg-geek-400 rounded-sm"})}),e.jsx("span",{className:"text-neutral-50 font-mono text-sm flex-1",children:i.content})]},i.rand_id||o))})]});return a?t.isInitialized?e.jsx(pe,{children:a&&e.jsxs("div",{className:"fixed inset-0 z-[900] flex items-center justify-center",children:[e.jsx(u.div,{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>{I(""),m()}}),e.jsx("div",{className:"relative z-10 w-full max-w-[800px] p-4",children:e.jsxs(u.div,{className:"relative w-full bg-black/80 border border-neutral-300 rounded-md",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},children:[e.jsx("div",{className:"p-5 border-b border-neutral-300/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-geek-400 font-mono",children:t.category}),e.jsx("h2",{className:"text-2xl text-neutral-50 font-mono",children:t.title}),e.jsxs("span",{className:"text-yellow-400 font-mono",children:[t.points," pts"]})]}),e.jsx(N,{variant:"ghost",size:"icon",className:"!text-neutral-400 hover:!text-neutral-50",onClick:()=>{I(""),m()},children:"✕"})]})}),e.jsxs("div",{className:"p-5 space-y-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1.5 flex-1 min-w-0",children:[e.jsx("h3",{className:"text-neutral-400 font-mono text-sm",children:"Description"}),e.jsx("p",{className:"text-neutral-50",children:t.description})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(N,{variant:"primary",size:"action",onClick:X,disabled:x.resetting,loading:x.resetting,className:x.resetting?"border-yellow-400 text-yellow-400":"",children:x.resetting?"RESETTING...":"RESET FLAG"})})]}),((H=t.attachments)==null?void 0:H.length)>0&&e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("h3",{className:"text-neutral-400 font-mono text-sm",children:"Attachments"}),e.jsx("div",{className:"space-y-1.5",children:t.attachments.map((i,o)=>e.jsxs(u.a,{href:i.url,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2 border border-neutral-300/30 rounded-md\r
                                                        text-neutral-300 hover:text-geek-400 hover:border-geek-400\r
                                                        transition-colors duration-200 cursor-pointer`,whileHover:{x:5},onClick:y=>{y.preventDefault(),T(i)},children:[e.jsx("span",{className:"text-sm",children:"📎"}),e.jsx("span",{className:"font-mono text-sm",children:i.name}),e.jsx("span",{className:"text-neutral-400 text-sm ml-auto",children:i.size})]},o))})]}),Q(),t.hasInstance&&Z(),ee(),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("h3",{className:"text-neutral-400 font-mono text-sm",children:t.type==="question"?"提交答案":"Submit Flag"}),t.type==="question"?e.jsxs("form",{onSubmit:G,className:"flex gap-2",children:[e.jsx("div",{className:"flex-1 h-[40px] bg-black/20 border border-neutral-300 rounded-md px-4 flex items-center",children:e.jsx("span",{className:"text-neutral-400 font-mono text-sm",children:$.length>0?`已选择 ${$.length} 个选项`:"请选择答案选项"})}),e.jsx(N,{type:"submit",variant:"primary",size:"action",disabled:t.isSolved||x.submitting||$.length===0,children:x.submitting?"SUBMITTING...":`${t.isSolved?"SOLVED":"SUBMIT"} ${t.attempts}/${t.maxAttempts||"∞"}`})]}):e.jsxs("form",{onSubmit:G,className:"flex gap-2",children:[e.jsx("input",{type:"text",onChange:i=>I(i.target.value),placeholder:`${l.prefix}{...}`,className:`flex-1 h-[40px] bg-black/20 border border-neutral-300 rounded-md px-4\r
                                                  text-neutral-50 placeholder-neutral-400\r
                                                  focus:border-geek-400 focus:shadow-[0_0_15px_rgba(89,126,247,0.3)]\r
                                                  transition-all duration-200`}),e.jsx(N,{type:"submit",variant:"primary",size:"action",disabled:t.isSolved||x.submitting||!S.trim(),children:x.submitting?"SUBMITTING...":`${t.isSolved?"SOLVED":"SUBMIT"} ${t.attempts}/${t.maxAttempts||"∞"}`})]}),w&&e.jsx(u.div,{className:"text-red-400 text-sm mt-2",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},children:w})]})]})]})})]})}):e.jsxs("div",{className:"fixed inset-0 z-[900] flex items-center justify-center",children:[e.jsx(u.div,{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>{I(""),m()}}),e.jsx("div",{className:"relative z-10 w-full max-w-[800px] p-4",children:e.jsxs(u.div,{className:"relative w-full bg-black/80 border border-neutral-300 rounded-md",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},children:[e.jsx("div",{className:"p-5 border-b border-neutral-300/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-geek-400 font-mono",children:t.category}),e.jsx("h2",{className:"text-2xl text-neutral-50 font-mono",children:t.title}),e.jsxs("span",{className:"text-yellow-400 font-mono",children:[t.points," pts"]})]}),e.jsx(N,{variant:"ghost",size:"icon",className:"!text-neutral-400 hover:!text-neutral-50",onClick:()=>{I(""),m()},children:"✕"})]})}),e.jsxs("div",{className:"p-12 flex flex-col items-center justify-center space-y-4",children:[w&&e.jsx(u.div,{className:"text-red-400 text-sm",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},children:w}),e.jsx("span",{className:"text-neutral-400 text-sm",children:"Initialize the challenge to view its content"}),e.jsx(N,{variant:"primary",size:"action",onClick:J,disabled:x.initializing,loading:x.initializing,className:x.initializing?"border-yellow-400 text-yellow-400":"",children:x.initializing?"INITIALIZING...":"INITIALIZE CHALLENGE"})]})]})})]}):null}const oe=(t,l={limit:10,offset:0})=>D({url:`/contests/${t}/challenges`,method:"GET",params:l}),ce=(t,l)=>D({url:`/contests/${t}/challenges/${l}`,method:"GET"}),Te=(t,l)=>D({url:`/contests/${t}/challenges/${l}/init`,method:"POST"}),De=(t,l)=>D({url:`/contests/${t}/challenges/${l}/attachment`,method:"GET",responseType:"blob"}).then(a=>a),$e=(t,l)=>D({url:`/contests/${t}/challenges/${l}/start`,method:"POST"}),Re=(t,l)=>D({url:`/contests/${t}/challenges/${l}/increase`,method:"POST"}),Le=(t,l)=>D({url:`/contests/${t}/challenges/${l}/stop`,method:"POST"}),Ee=(t,l,a)=>D({url:`/contests/${t}/challenges/${l}/submit`,method:"POST",data:a}),Ie=(t,l)=>D({url:`/contests/${t}/challenges/${l}/reset`,method:"POST"}),ze=(t,l)=>{const a=new FormData;return a.append("writeup",l),D({url:`/contests/${t}/writeups`,method:"POST",data:a,headers:{"Content-Type":"multipart/form-data"}})},Ae=t=>D({url:`/contests/${t}/writeups`,method:"GET"}),Oe=(t,l)=>{const a=new Date().getTime(),m=new Date(t.start).getTime(),g=m+t.duration*1e3;return{status:a<m?"upcoming":a>g?"ended":"running",startTime:new Date(m).toISOString(),endTime:new Date(g).toISOString(),joined:!0,duration:t.duration/3600,prefix:t.prefix,team:{score:l.data.score,rank:l.data.rank||0,solved:l.data.solved.reduce((h,d)=>h+d.solved,0)},teams:t.teams,totalChallenges:l.data.solved.reduce((h,d)=>h+d.all,0)}},Me=t=>{const l=new Set(["ALL"]);return t.forEach(a=>{a.category&&l.add(a.category)}),Array.from(l)},Pe=t=>({id:t.id,type:t.type,category:t.category,title:t.name,points:t.current_score,description:t.desc,attachments:[],hasInstance:t.type==="pods",hasAttachments:t.type==="dynamic",instanceRunning:t.remote.status==="Running",instanceIP:t.remote.target||[""],instanceDuration:t.remote.remaining||0,instanceTimeLeft:t.remote.remaining||0,solves:t.solvers||0,isInitialized:t.init,solved:t.solved,attempts:t.attempts,maxAttempts:t.attempt,scoreInfo:{initial:t.score,current:t.current_score,minimum:t.min_score,decay:t.decay,scoreType:t.score_type},hints:t.hints,tags:t.tags,hidden:t.hidden,options:t.options||[]});function We(){const{contestId:t}=fe(),l=ge(),[a,m]=c.useState({}),[g,h]=c.useState(["ALL"]),[d,j]=c.useState("ALL"),[k,C]=c.useState([]),[T,x]=c.useState(0),[n,w]=c.useState(1),[v,S]=c.useState(null),[I,$]=c.useState(!0),[P,se]=c.useState(null),[B,_]=c.useState([]),[V,z]=c.useState([]),[q,Y]=c.useState(!1),R=12,{addMessageHandler:J}=de();c.useEffect(()=>J(s=>{if(s.type==="start_victim"||s.type==="stop_victim"||s.type==="generate_attachment"){switch(s.level){case"error":p.danger({title:s.title,description:s.msg});break;case"warning":p.warning({title:s.title,description:s.msg});break;case"success":p.success({title:s.title,description:s.msg});break;case"info":p.info({title:s.title,description:s.msg});break;default:p.default({title:s.title,description:s.msg});break}A()}}),[J]),c.useEffect(()=>{X()},[t]),c.useEffect(()=>{t&&n>0&&F(n,d)},[n,t]),c.useEffect(()=>{(a==null?void 0:a.status)==="ended"&&K()},[t,a==null?void 0:a.status]);const X=async()=>{try{const[s,r,f,b]=await Promise.all([ye(t),Ne(t),we(t),be(t)]);if(s.code===200&&r.code===200){const O=Oe(s.data,f);m(O),_(b.data.notices.map(E=>({type:E.type||"info",title:E.title,message:E.content}))),se({members:r.data.map(E=>E.avatar),name:f.data.name}),await ae(),await F(1,d)}}catch(s){p.danger({title:"获取数据失败",description:s.message})}finally{$(!1)}},ae=async()=>{try{const s=await oe(t,{limit:1e3,offset:0});if(s.code===200){const r=s.data===null?[]:s.data,f=Me(r.challenges||[]);h(f)}}catch(s){console.error("获取分类失败:",s)}},F=async(s,r)=>{try{const f={limit:R,offset:(s-1)*R};r!=="ALL"&&(f.category=r);const b=await oe(t,f);if(b.code===200){const O=b.data===null?[]:b.data,E=(O.challenges||[]).map(te=>Pe(te));C(E),x(O.count||0)}else p.danger({description:b.msg||"获取题目列表失败"})}catch(f){p.danger({description:"获取题目列表失败"}),console.error(f)}},K=async()=>{try{const s=await Ae(t);s.code===200&&s.data.writeups&&z(s.data.writeups)}catch(s){console.error("Failed to fetch writeups:",s)}},A=async()=>{if(v)try{const s=await ce(t,v.id);if(s.code===200){const r={...v,attachments:s.data.file?[{name:s.data.file}]:[],isInitialized:s.data.init,isSolved:s.data.solved,instanceRunning:s.data.remote.status==="Running",instanceIP:s.data.remote.target||[""],instanceDuration:s.data.remote.remaining||0,instanceTimeLeft:s.data.remote.remaining||0};S(r),C(f=>f.map(b=>b.id===r.id?r:b))}}catch(s){console.error("Failed to refresh challenge status:",s)}},G=async s=>{try{const r=await Te(t,s);if(r.code===200)return p.success({title:r.msg||"题目初始化成功"}),await A(),!0}catch(r){p.danger({title:"初始化失败",description:r.message})}return!1},U=async s=>{try{if((await Ie(t,s)).code===200)return p.success({title:"任务下发成功"}),!0}catch(r){p.danger({title:"重置失败",description:r.message})}return!1},Z=async s=>{try{if((await $e(t,s)).code===200)return p.success({title:"任务下发成功"}),!0}catch(r){p.danger({title:"任务下发启动失败",description:r.message})}return!1},Q=async s=>{try{const r=await Re(t,s);if(r.code===200)return p.success({title:r.msg||"延长时间成功"}),await A(),!0}catch(r){p.danger({title:"延长时间失败",description:r.message})}return!1},ee=async s=>{try{const r=await Le(t,s);if(r.code===200)return p.success({title:r.msg||"靶机已销毁"}),await A(),!0}catch(r){p.danger({title:"销毁失败",description:r.message})}return!1},H=async(s,r)=>{try{const b=await Ee(t,s,{flag:r});return await A(),await X(),b.code===200?(p.success({title:b.msg||"提交成功"}),{success:!0,message:"提交成功！"}):(p.danger({title:b.msg}),{success:!0,message:b.msg})}catch(f){return{success:!1,message:f.message}}},i=s=>{j(s),w(1),F(1,s)},o=async s=>{try{const r=await ce(t,s.id);if(r.code===200){const f={...s,attachments:r.data.file?[{name:r.data.file}]:[],isInitialized:r.data.init,isSolved:r.data.solved,instanceRunning:r.data.remote.status==="Running",instanceIP:r.data.remote.target||[""],instanceTimeLeft:r.data.remote.remaining||0,instanceDuration:r.data.remote.duration||3600,options:s.options||[]};S(f)}}catch(r){console.error("Failed to get challenge status:",r),p.danger({title:"获取题目状态失败",description:r.message}),S(s)}},y=async s=>{var r;try{const f=await De(t,v.id),b=(r=f.headers)==null?void 0:r["content-disposition"];let O=s.name;if(b){const ne=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(b);ne!=null&&ne[1]&&(O=ne[1].replace(/['"]/g,""))}const E=new Blob([f.data]),te=window.URL.createObjectURL(E),W=document.createElement("a");W.href=te,W.setAttribute("download",O),document.body.appendChild(W),W.click(),document.body.removeChild(W),window.URL.revokeObjectURL(te),p.success({title:"附件下载成功"})}catch(f){console.error("Failed to download attachment:",f),p.danger({title:"下载失败",description:f.message})}},L=async s=>{try{$(!0);const r=await ze(t,s);r.code===200?(p.success({title:"题解上传成功",description:"感谢您分享您的解题思路！"}),K()):p.danger({title:"题解上传失败",description:r.msg||"请稍后再试"})}catch(r){console.error("Failed to upload writeup:",r),p.danger({title:"题解上传失败",description:r.message||"发生了未知错误"})}finally{$(!1)}},ue=()=>{Y(!0)},xe=()=>{Y(!1),S(null)};return I?e.jsx(je,{}):e.jsxs("div",{className:"w-full max-w-[1200px] mx-auto space-y-6",children:[e.jsx(Ce,{contestStatus:a,onStatusExpired:s=>{m(r=>({...r,status:s}))},notifications:B}),(a==null?void 0:a.status)==="upcoming"?e.jsx(ke,{startTime:a.startTime,joined:a.joined,onJoin:()=>{}}):(a==null?void 0:a.status)==="ended"?q?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsx(N,{variant:"secondary",size:"sm",onClick:xe,children:"← BACK TO CONTEST SUMMARY"})}),e.jsx(ie,{categories:g,selectedCategory:d,onCategoryChange:i,challenges:k,onChallengeClick:o,teamInfo:P,totalCount:T,currentPage:n,pageSize:R,onPageChange:w}),e.jsx(le,{challenge:v,contest:a,isOpen:!!v,onClose:()=>S(null),onInitialize:G,onReset:U,onLaunchInstance:Z,onExtendInstance:Q,onDestroyInstance:ee,onSubmitFlag:H,onDownloadAttachment:y})]}):e.jsx(Se,{contestInfo:{duration:`${a.duration}h`,totalTeams:a.teams,totalChallenges:a.totalChallenges,teamRank:a.team.rank,teamScore:a.team.score,teamSolved:a.team.solved},onViewScoreboard:()=>{l(`/contests/${t}/scoreboard`)},onUploadWriteup:L,onViewChallenges:ue,writeups:V}):e.jsxs("div",{children:[e.jsx(ie,{categories:g,selectedCategory:d,onCategoryChange:i,challenges:k,onChallengeClick:o,teamInfo:P,totalCount:T,currentPage:n,pageSize:R,onPageChange:w}),e.jsx(le,{challenge:v,contest:a,isOpen:!!v,onClose:()=>S(null),onInitialize:G,onReset:U,onLaunchInstance:Z,onExtendInstance:Q,onDestroyInstance:ee,onSubmitFlag:H,onDownloadAttachment:y})]})]})}export{We as default};
