import{c as G,r as w,j as e,m as R,B as C,a as c,t as b}from"./index-DWnK0TXq.js";import{A as U,L as E}from"./AdminList-n8Oy1fc4.js";import{A as J}from"./AdminPagination-DluKrlAy.js";import{I as q}from"./IconPlus-L0q5EmfX.js";import{I as be}from"./IconEdit-DtBBU1XU.js";import{I as B}from"./IconTrash-zHFLqkpL.js";import{I as je}from"./IconEye-CnYNv3_v.js";import{A as F,M}from"./AdminModal-CcpQgLj_.js";import"./IconChevronsRight-BoKb-jjv.js";import"./IconX-DnOZQPbW.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M12 8l0 4l2 2",key:"svg-0"}],["path",{d:"M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5",key:"svg-1"}]],ve=G("outline","history","History",ge);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M4.876 13.61a4 4 0 1 0 6.124 3.39h6",key:"svg-0"}],["path",{d:"M15.066 20.502a4 4 0 1 0 1.934 -7.502c-.706 0 -1.424 .179 -2 .5l-3 -5.5",key:"svg-1"}],["path",{d:"M16 8a4 4 0 1 0 -8 0c0 1.506 .77 2.818 2 3.5l-3 5.5",key:"svg-2"}]],K=G("outline","webhook","Webhook",Ne),ye=(r={limit:10,offset:0})=>w({url:"/admin/webhook",method:"GET",params:r}),ke=r=>w({url:"/admin/webhook",method:"POST",data:r}),Ce=(r,p)=>w({url:`/admin/webhook/${r}`,method:"PUT",data:p}),we=r=>w({url:`/admin/webhook/${r}`,method:"DELETE"}),We=(r={limit:10,offset:0})=>w({url:"/admin/webhook/history",method:"GET",params:r}),Se=()=>w({url:"/admin/webhook/events",method:"GET"});function Te({webhooks:r=[],totalCount:p=0,currentPage:W=1,pageSize:j=10,loading:g=!1,onPageChange:S,onCreateWebhook:u,onEditWebhook:v,onDeleteWebhook:o,onViewHistory:n,onWebhookClick:l}){const m=[{key:"id",label:"ID",width:"5%"},{key:"name",label:"名称",width:"15%"},{key:"url",label:"URL",width:"20%"},{key:"method",label:"方法",width:"8%"},{key:"status",label:"状态",width:"10%"},{key:"events",label:"事件",width:"15%"},{key:"success",label:"成功次数",width:"10%"},{key:"failure",label:"失败次数",width:"10%"},{key:"actions",label:"操作",width:"7%"}],N=(s,d)=>{switch(d.key){case"id":return e.jsx("div",{className:"flex flex-col",children:e.jsxs("span",{className:"text-neutral-50 font-medium",children:["#",s.id]})});case"name":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:s.name})});case"url":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 font-mono text-sm truncate max-w-48",title:s.url,children:s.url})});case"method":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:`text-sm font-mono px-2 py-1 rounded ${s.method==="GET"?"bg-blue-400/20 text-blue-400":s.method==="POST"?"bg-green-400/20 text-green-400":s.method==="PUT"?"bg-yellow-400/20 text-yellow-400":s.method==="DELETE"?"bg-red-400/20 text-red-400":"bg-neutral-400/20 text-neutral-400"}`,children:s.method})});case"status":return e.jsx("div",{className:"flex flex-wrap gap-2",children:s.on?e.jsx(E,{type:"success",text:"已启用"}):e.jsx(E,{type:"warning",text:"已禁用"})});case"events":return e.jsx("div",{className:"flex flex-col",children:s.events&&s.events.length>0?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.events.slice(0,2).map((f,H)=>e.jsx("span",{className:"text-xs bg-neutral-700 text-neutral-300 px-1 py-0.5 rounded",children:f},H)),s.events.length>2&&e.jsxs("span",{className:"text-xs text-neutral-400",children:["+",s.events.length-2]})]}):e.jsx("span",{className:"text-neutral-500 text-sm",children:"全部事件"})});case"success":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-green-400 font-medium",children:s.success||0}),s.success_last&&e.jsx("span",{className:"text-xs text-neutral-400",children:new Date(s.success_last).toLocaleString()})]});case"failure":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-red-400 font-medium",children:s.failure||0}),s.failure_last&&e.jsx("span",{className:"text-xs text-neutral-400",children:new Date(s.failure_last).toLocaleString()})]});case"actions":return e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),v==null||v(s)},className:"p-1",title:"编辑",children:e.jsx(be,{size:16})}),e.jsx(C,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),n==null||n(s)},className:"p-1",title:"查看历史",children:e.jsx(ve,{size:16})}),e.jsx(C,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),o==null||o(s)},className:"p-1 text-red-400 hover:text-red-300",title:"删除",children:e.jsx(B,{size:16})})]});default:return null}};return e.jsx("div",{className:"w-full max-w-[1200px] mx-auto",children:e.jsxs(R.div,{className:"rounded-md bg-black/30 backdrop-blur-[2px] overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{size:24,className:"text-neutral-50"}),e.jsx("h1",{className:"text-3xl font-mono text-neutral-50",children:"Webhook 管理"})]}),e.jsx(C,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(q,{size:16}),onClick:u,children:"添加 Webhook 配置"})]}),e.jsx(U,{data:r,columns:m,renderCell:N,onRowClick:l,loading:g,empty:r.length===0,emptyContent:"暂无 Webhook 配置"}),p>j&&e.jsx(J,{currentPage:W,totalCount:p,pageSize:j,onPageChange:S})]})})}function Ee({webhookHistory:r=[],totalCount:p=0,currentPage:W=1,pageSize:j=10,loading:g=!1,onPageChange:S,onViewDetail:u,onHistoryClick:v}){const o=[{key:"id",label:"ID",width:"5%"},{key:"webhook",label:"Webhook",width:"15%"},{key:"event",label:"事件",width:"15%"},{key:"status",label:"状态",width:"10%"},{key:"resp",label:"响应码",width:"10%"},{key:"duration",label:"耗时",width:"10%"},{key:"time",label:"调用时间",width:"12%"},{key:"actions",label:"操作",width:"5%"}],n=(l,m)=>{switch(m.key){case"id":return e.jsx("div",{className:"flex flex-col",children:e.jsxs("span",{className:"text-neutral-50 font-medium",children:["#",l.id]})});case"webhook":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:l.webhook})});case"event":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:l.event})});case"status":return e.jsx("div",{className:"flex flex-wrap gap-2",children:l.success?e.jsx(E,{type:"success",text:"成功"}):e.jsx(E,{type:"error",text:"失败"})});case"resp":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:`text-sm font-mono ${l.resp>=200&&l.resp<300?"text-green-400":l.resp>=400&&l.resp<500?"text-yellow-400":l.resp>=500?"text-red-400":"text-neutral-400"}`,children:l.resp||"-"})});case"duration":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 text-sm",children:l.duration?`${l.duration}ms`:"-"})});case"time":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 text-sm",children:new Date(l.time).toLocaleString()})});case"actions":return e.jsx("div",{className:"flex gap-2",children:e.jsx(C,{variant:"ghost",size:"sm",onClick:N=>{N.stopPropagation(),u==null||u(l)},className:"p-1",title:"查看详情",children:e.jsx(je,{size:16})})});default:return null}};return e.jsx("div",{className:"w-full max-w-[1200px] mx-auto",children:e.jsxs(R.div,{className:"rounded-md bg-black/30 backdrop-blur-[2px] overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{size:24,className:"text-neutral-50"}),e.jsx("h1",{className:"text-3xl font-mono text-neutral-50",children:"Webhook 调用历史"})]})}),e.jsx(U,{data:r,columns:o,renderCell:n,onRowClick:v,loading:g,empty:r.length===0,emptyContent:"暂无 Webhook 调用记录"}),p>j&&e.jsx(J,{currentPage:W,totalCount:p,pageSize:j,onPageChange:S})]})})}function De(){const[r,p]=c.useState([]),[W,j]=c.useState(0),[g,S]=c.useState(1),u=10,[v,o]=c.useState(!1),[n,l]=c.useState(null),[m,N]=c.useState("edit"),[s,d]=c.useState({name:"",url:"",method:"POST",headers:{},timeout:30,retry:3,events:[],on:!1}),[f,H]=c.useState([]),[Q,X]=c.useState(0),[P,O]=c.useState(1),[x,Y]=c.useState(null),[Z,I]=c.useState(!1),[y,z]=c.useState("webhook"),[V,L]=c.useState(null),[A,ee]=c.useState([]);c.useEffect(()=>{y==="webhook"?T():y==="history"&&se()},[g,P,y,V]),c.useEffect(()=>{te()},[]);const te=async()=>{try{const t=await Se();t.code===200&&ee(t.data||[])}catch(t){console.error("获取事件列表失败:",t)}},T=async()=>{try{const t=await ye({limit:u,offset:(g-1)*u});t.code===200&&(p(t.data.webhooks||t.data),j(t.data.count||t.data.length))}catch(t){b.danger({description:"获取Webhook配置列表失败"}),console.error(t)}},se=async()=>{try{const t=await We({limit:u,offset:(P-1)*u});t.code===200&&(H(t.data.histories||t.data),X(t.data.count||t.data.length))}catch(t){b.danger({description:"获取Webhook历史记录失败"}),console.error(t)}},ae=()=>{N("create"),l(null),d({name:"",url:"",method:"POST",headers:{},timeout:30,retry:3,events:[],on:!1}),o(!0)},_=t=>{N("edit"),l(t),d({name:t.name,url:t.url,method:t.method,headers:t.headers||{},timeout:t.timeout||30,retry:t.retry||3,events:t.events||[],on:t.on}),o(!0)},le=t=>{N("delete"),l(t),o(!0)},ne=t=>{L(t.id),z("history"),O(1)},re=()=>{L(null),z("history"),O(1)},ce=t=>{_(t)},$=t=>{Y(t),I(!0)},ie=async()=>{try{const t={};Object.entries(s.headers).forEach(([h,k])=>{h&&h.trim()!==""&&k&&k.trim()!==""&&(t[h.trim()]=k.trim())});const a={...s,headers:t};(await ke(a)).code===200&&(b.success({description:"创建Webhook配置成功"}),o(!1),T())}catch(t){b.danger({description:"创建Webhook配置失败"}),console.error(t)}},oe=async()=>{try{const t={};Object.entries(s.headers).forEach(([h,k])=>{h&&h.trim()!==""&&k&&k.trim()!==""&&(t[h.trim()]=k.trim())});const a={};s.name!==n.name&&(a.name=s.name),s.url!==n.url&&(a.url=s.url),s.method!==n.method&&(a.method=s.method),JSON.stringify(t)!==JSON.stringify(n.headers)&&(a.headers=t),s.timeout!==n.timeout&&(a.timeout=s.timeout),s.retry!==n.retry&&(a.retry=s.retry),JSON.stringify(s.events)!==JSON.stringify(n.events)&&(a.events=s.events),s.on!==n.on&&(a.on=s.on),(await Ce(n.id,a)).code===200&&(b.success({description:"更新Webhook配置成功"}),o(!1),T())}catch(t){b.danger({description:"更新Webhook配置失败"}),console.error(t)}},de=async()=>{try{(await we(n.id)).code===200&&(b.success({description:"删除Webhook配置成功"}),o(!1),T())}catch(t){b.danger({description:"删除Webhook配置失败"}),console.error(t)}},D=(t,a)=>{const i={...s.headers};a===""||a.trim()===""?delete i[t]:i[t]=a.trim(),d({...s,headers:i})},me=()=>{let t=1,a=`header_${t}`;for(;Object.prototype.hasOwnProperty.call(s.headers,a);)t++,a=`header_${t}`;const i={...s.headers,[a]:""};d({...s,headers:i})},xe=(t,a,i)=>{const h={...s.headers};delete h[t],a&&a.trim()!==""&&(h[a.trim()]=i),d({...s,headers:h})},ue=t=>{const a=s.events.includes(t)?s.events.filter(i=>i!==t):[...s.events,t];d({...s,events:a})},he=()=>m==="delete"?e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-neutral-300 mb-4",children:["确定要删除 Webhook 配置 ",e.jsx("span",{className:"font-semibold text-red-400",children:n==null?void 0:n.name})," 吗？"]}),e.jsx("p",{className:"text-neutral-400 text-sm",children:"此操作不可撤销。"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"名称 *"}),e.jsx("input",{type:"text",required:!0,value:s.name,onChange:t=>d({...s,name:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"标识名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"HTTP方法 *"}),e.jsxs("select",{value:s.method,onChange:t=>d({...s,method:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"GET",children:"GET"}),e.jsx("option",{value:"POST",children:"POST"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"URL *"}),e.jsx("input",{type:"url",required:!0,value:s.url,onChange:t=>d({...s,url:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"https://example.com/webhook"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"超时时间(秒)"}),e.jsx("input",{type:"number",value:s.timeout,onChange:t=>d({...s,timeout:parseInt(t.target.value)||30}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",max:"300"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"重试次数"}),e.jsx("input",{type:"number",value:s.retry,onChange:t=>d({...s,retry:parseInt(t.target.value)||3}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0",max:"10"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium",children:"请求头"}),e.jsx(C,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(q,{size:16}),onClick:me,children:"添加请求头"})]}),e.jsx("div",{className:"space-y-2",children:Object.entries(s.headers).map(([t,a])=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"text",value:t,onChange:i=>xe(t,i.target.value,a),className:"flex-1 px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Header名称"}),e.jsx("input",{type:"text",value:a,onChange:i=>D(t,i.target.value),className:"flex-1 px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Header值"}),e.jsx(C,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>D(t,""),children:e.jsx(B,{size:18})})]},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"监听事件"}),e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3 max-h-40 overflow-y-auto",children:A.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-2",children:A.map(t=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:s.events.includes(t),onChange:()=>ue(t),className:"text-blue-500"}),e.jsx("span",{className:"text-neutral-300 text-sm",children:t})]},t))}):e.jsx("p",{className:"text-neutral-500 text-sm",children:"暂无可用事件"})}),e.jsx("p",{className:"text-neutral-400 text-xs mt-1",children:"不选择任何事件表示监听所有事件"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"on",checked:s.on,onChange:t=>d({...s,on:t.target.checked}),className:"mr-2"}),e.jsx("label",{htmlFor:"on",className:"text-neutral-300",children:"启用此Webhook配置"})]})]}),pe=()=>x?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"Webhook"}),e.jsx("div",{className:"text-neutral-50",children:x.webhook})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"事件"}),e.jsx("div",{className:"text-neutral-50",children:x.event})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"状态"}),e.jsx("div",{children:x.success?e.jsx("span",{className:"text-green-400",children:"成功"}):e.jsx("span",{className:"text-red-400",children:"失败"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"响应码"}),e.jsx("div",{className:"text-neutral-50",children:x.resp||"-"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"耗时"}),e.jsx("div",{className:"text-neutral-50",children:x.duration?`${x.duration}ms`:"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"重试次数"}),e.jsx("div",{className:"text-neutral-50",children:x.retry||0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"调用时间"}),e.jsx("div",{className:"text-neutral-50",children:new Date(x.time).toLocaleString()})]}),x.next_retry&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"下次重试"}),e.jsx("div",{className:"text-neutral-50",children:new Date(x.next_retry).toLocaleString()})]})]}),x.error&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"错误信息"}),e.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:e.jsx("pre",{className:"text-red-300 text-sm whitespace-pre-wrap font-mono",children:x.error})})]})]}):null,fe=()=>e.jsxs(e.Fragment,{children:[e.jsx(M,{onClick:()=>o(!1),children:"取消"}),e.jsx(M,{variant:m==="delete"?"danger":"primary",onClick:m==="create"?ie:m==="edit"?oe:de,children:m==="create"?"创建":m==="edit"?"保存":"删除"})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full max-w-[1200px] mx-auto mb-6",children:e.jsxs("div",{className:"flex border-b border-neutral-700",children:[e.jsx("button",{className:`px-6 py-3 text-sm font-medium transition-colors ${y==="webhook"?"text-blue-400 border-b-2 border-blue-400":"text-neutral-400 hover:text-neutral-300"}`,onClick:()=>z("webhook"),children:"Webhook 配置"}),e.jsx("button",{className:`px-6 py-3 text-sm font-medium transition-colors ${y==="history"?"text-blue-400 border-b-2 border-blue-400":"text-neutral-400 hover:text-neutral-300"}`,onClick:re,children:"调用历史"})]})}),y==="webhook"&&e.jsx(Te,{webhooks:r,totalCount:W,currentPage:g,pageSize:u,loading:!1,onPageChange:S,onCreateWebhook:ae,onEditWebhook:_,onDeleteWebhook:le,onViewHistory:ne,onWebhookClick:ce}),y==="history"&&e.jsx(Ee,{webhookHistory:f,totalCount:Q,currentPage:P,pageSize:u,loading:!1,onPageChange:O,onViewDetail:$,onHistoryClick:$}),e.jsx(F,{isOpen:v,onClose:()=>o(!1),title:m==="create"?"创建 Webhook 配置":m==="edit"?"编辑 Webhook 配置":"删除 Webhook 配置",size:m!=="delete"?"lg":"sm",footer:fe(),children:he()}),e.jsx(F,{isOpen:Z,onClose:()=>I(!1),title:"Webhook 调用详情",size:"lg",footer:e.jsx(M,{onClick:()=>I(!1),children:"关闭"}),children:pe()})]})}export{De as default};
