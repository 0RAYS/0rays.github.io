import{c as ve,r as C,j as e,m as B,B as k,a as l,t as j}from"./index-jDIg2lLK.js";import{A as J,L as P}from"./AdminList-BMVnft9P.js";import{A as q}from"./AdminPagination-DTSJVg5u.js";import{I as Q}from"./IconPlus-Bl3ddmYu.js";import{I as ye}from"./IconEdit-D6LJwKPR.js";import{I as ke}from"./IconHistory-BqmYhDOr.js";import{I as X}from"./IconTrash-Bv8W_iLs.js";import{I as Ce}from"./IconEye-HIm1GCYd.js";import{A as R,M as $}from"./AdminModal-A_7p_LOm.js";import"./IconChevronsRight-BGvI8wkk.js";import"./IconX-AH9QJCni.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M4.876 13.61a4 4 0 1 0 6.124 3.39h6",key:"svg-0"}],["path",{d:"M15.066 20.502a4 4 0 1 0 1.934 -7.502c-.706 0 -1.424 .179 -2 .5l-3 -5.5",key:"svg-1"}],["path",{d:"M16 8a4 4 0 1 0 -8 0c0 1.506 .77 2.818 2 3.5l-3 5.5",key:"svg-2"}]],Y=ve("outline","webhook","Webhook",we),We=(n={limit:10,offset:0})=>C({url:"/admin/webhook",method:"GET",params:n}),Se=n=>C({url:"/admin/webhook",method:"POST",data:n}),Te=(n,x)=>C({url:`/admin/webhook/${n}`,method:"PUT",data:x}),Ee=n=>C({url:`/admin/webhook/${n}`,method:"DELETE"}),He=(n={limit:10,offset:0})=>C({url:"/admin/webhook/history",method:"GET",params:n}),Oe=(n,x={limit:10,offset:0})=>C({url:`/admin/webhook/${n}/history`,method:"GET",params:x}),Pe=()=>C({url:"/admin/webhook/events",method:"GET"});function Ie({webhooks:n=[],totalCount:x=0,currentPage:w=1,pageSize:g=10,loading:N=!1,onPageChange:W,onCreateWebhook:v,onEditWebhook:u,onDeleteWebhook:i,onViewHistory:p,onWebhookClick:h}){const c=[{key:"id",label:"ID",width:"5%"},{key:"name",label:"名称",width:"15%"},{key:"url",label:"URL",width:"20%"},{key:"method",label:"方法",width:"8%"},{key:"status",label:"状态",width:"10%"},{key:"events",label:"事件",width:"15%"},{key:"success",label:"成功次数",width:"10%"},{key:"failure",label:"失败次数",width:"10%"},{key:"actions",label:"操作",width:"7%"}],s=(a,T)=>{switch(T.key){case"id":return e.jsx("div",{className:"flex flex-col",children:e.jsxs("span",{className:"text-neutral-50 font-medium",children:["#",a.id]})});case"name":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:a.name})});case"url":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 font-mono text-sm truncate max-w-48",title:a.url,children:a.url})});case"method":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:`text-sm font-mono px-2 py-1 rounded ${a.method==="GET"?"bg-blue-400/20 text-blue-400":a.method==="POST"?"bg-green-400/20 text-green-400":a.method==="PUT"?"bg-yellow-400/20 text-yellow-400":a.method==="DELETE"?"bg-red-400/20 text-red-400":"bg-neutral-400/20 text-neutral-400"}`,children:a.method})});case"status":return e.jsx("div",{className:"flex flex-wrap gap-2",children:a.on?e.jsx(P,{type:"success",text:"已启用"}):e.jsx(P,{type:"warning",text:"已禁用"})});case"events":return e.jsx("div",{className:"flex flex-col",children:a.events&&a.events.length>0?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[a.events.slice(0,2).map((b,I)=>e.jsx("span",{className:"text-xs bg-neutral-700 text-neutral-300 px-1 py-0.5 rounded",children:b},I)),a.events.length>2&&e.jsxs("span",{className:"text-xs text-neutral-400",children:["+",a.events.length-2]})]}):e.jsx("span",{className:"text-neutral-500 text-sm",children:"全部事件"})});case"success":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-green-400 font-medium",children:a.success||0}),a.success_last&&e.jsx("span",{className:"text-xs text-neutral-400",children:new Date(a.success_last).toLocaleString()})]});case"failure":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-red-400 font-medium",children:a.failure||0}),a.failure_last&&e.jsx("span",{className:"text-xs text-neutral-400",children:new Date(a.failure_last).toLocaleString()})]});case"actions":return e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:b=>{b.stopPropagation(),u==null||u(a)},className:"p-1",title:"编辑",children:e.jsx(ye,{size:16})}),e.jsx(k,{variant:"ghost",size:"sm",onClick:b=>{b.stopPropagation(),p==null||p(a)},className:"p-1",title:"查看历史",children:e.jsx(ke,{size:16})}),e.jsx(k,{variant:"ghost",size:"sm",onClick:b=>{b.stopPropagation(),i==null||i(a)},className:"p-1 text-red-400 hover:text-red-300",title:"删除",children:e.jsx(X,{size:16})})]});default:return null}};return e.jsx("div",{className:"w-full max-w-[1200px] mx-auto",children:e.jsxs(B.div,{className:"rounded-md bg-black/30 backdrop-blur-[2px] overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{size:24,className:"text-neutral-50"}),e.jsx("h1",{className:"text-3xl font-mono text-neutral-50",children:"Webhook 管理"})]}),e.jsx(k,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(Q,{size:16}),onClick:v,children:"添加 Webhook 配置"})]}),e.jsx(J,{data:n,columns:c,renderCell:s,onRowClick:h,loading:N,empty:n.length===0,emptyContent:"暂无 Webhook 配置"}),x>g&&e.jsx(q,{current:w,total:Math.ceil(x/g),onChange:W,showTotal:!0,totalItems:x})]})})}function ze({webhookHistory:n=[],totalCount:x=0,currentPage:w=1,pageSize:g=10,loading:N=!1,onPageChange:W,onViewDetail:v,onHistoryClick:u,webhookName:i}){const p=[{key:"id",label:"ID",width:"5%"},{key:"webhook",label:"Webhook",width:"15%"},{key:"event",label:"事件",width:"15%"},{key:"status",label:"状态",width:"10%"},{key:"resp",label:"响应码",width:"10%"},{key:"duration",label:"耗时",width:"10%"},{key:"time",label:"调用时间",width:"12%"},{key:"actions",label:"操作",width:"5%"}],h=(c,s)=>{switch(s.key){case"id":return e.jsx("div",{className:"flex flex-col",children:e.jsxs("span",{className:"text-neutral-50 font-medium",children:["#",c.id]})});case"webhook":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:c.webhook})});case"event":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:c.event})});case"status":return e.jsx("div",{className:"flex flex-wrap gap-2",children:c.success?e.jsx(P,{type:"success",text:"成功"}):e.jsx(P,{type:"error",text:"失败"})});case"resp":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:`text-sm font-mono ${c.resp>=200&&c.resp<300?"text-green-400":c.resp>=400&&c.resp<500?"text-yellow-400":c.resp>=500?"text-red-400":"text-neutral-400"}`,children:c.resp||"-"})});case"duration":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 text-sm",children:c.duration?`${c.duration}ms`:"-"})});case"time":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 text-sm",children:new Date(c.time).toLocaleString()})});case"actions":return e.jsx("div",{className:"flex gap-2",children:e.jsx(k,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),v==null||v(c)},className:"p-1",title:"查看详情",children:e.jsx(Ce,{size:16})})});default:return null}};return e.jsx("div",{className:"w-full max-w-[1200px] mx-auto",children:e.jsxs(B.div,{className:"rounded-md bg-black/30 backdrop-blur-[2px] overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{size:24,className:"text-neutral-50"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-mono text-neutral-50",children:"Webhook 调用历史"}),i&&e.jsxs("p",{className:"text-sm text-neutral-400 mt-1",children:["当前查看: ",i]})]})]})}),e.jsx(J,{data:n,columns:p,renderCell:h,onRowClick:u,loading:N,empty:n.length===0,emptyContent:"暂无 Webhook 调用记录"}),x>g&&e.jsx(q,{current:w,total:Math.ceil(x/g),onChange:W,showTotal:!0,totalItems:x})]})})}function Je(){var F;const[n,x]=l.useState([]),[w,g]=l.useState(0),[N,W]=l.useState(1),[v,u]=l.useState(!1),[i,p]=l.useState(null),[h,c]=l.useState("edit"),[s,a]=l.useState({name:"",url:"",method:"POST",headers:{},timeout:0,retry:0,events:[],on:!1}),[T,b]=l.useState({}),[I,Z]=l.useState([]),[K,V]=l.useState(0),[E,z]=l.useState(1),[f,ee]=l.useState(null),[te,M]=l.useState(!1),[y,A]=l.useState("webhook"),[S,U]=l.useState(null),[D,se]=l.useState([]);l.useEffect(()=>{y==="webhook"?H():y==="history"&&re()},[N,E,y,S]),l.useEffect(()=>{ae()},[]),l.useEffect(()=>()=>{Object.values(T).forEach(t=>{t&&clearTimeout(t)})},[T]);const ae=async()=>{try{const t=await Pe();t.code===200&&se(t.data||[])}catch(t){console.error("获取事件列表失败:",t)}},H=async()=>{try{const t=await We({limit:10,offset:(N-1)*10});t.code===200&&(x(t.data.webhooks||t.data),g(t.data.count||t.data.length))}catch(t){j.danger({description:"获取Webhook配置列表失败"}),console.error(t)}},re=async()=>{try{let t;S?t=await Oe(S,{limit:20,offset:(E-1)*20}):t=await He({limit:20,offset:(E-1)*20}),t.code===200&&(Z(t.data.histories||t.data),V(t.data.count||t.data.length))}catch(t){j.danger({description:"获取Webhook历史记录失败"}),console.error(t)}},le=()=>{c("create"),p(null),a({name:"",url:"",method:"POST",headers:{},timeout:0,retry:0,events:[],on:!1}),u(!0)},_=t=>{c("edit"),p(t),a({name:t.name,url:t.url,method:t.method,headers:t.headers||{},timeout:t.timeout,retry:t.retry,events:t.events||[],on:t.on}),u(!0)},ne=t=>{c("delete"),p(t),u(!0)},ie=t=>{U(t.id),A("history"),z(1)},ce=()=>{U(null),A("history"),z(1)},oe=t=>{_(t)},G=t=>{ee(t),M(!0)},de=async()=>{try{const t={};Object.entries(s.headers).forEach(([d,m])=>{d&&d.trim()!==""&&m&&m.trim()!==""&&(t[d.trim()]=m.trim())});const r={...s,headers:t};(await Se(r)).code===200&&(j.success({description:"创建Webhook配置成功"}),u(!1),H())}catch(t){j.danger({description:"创建Webhook配置失败"}),console.error(t)}},me=async()=>{try{const t={};Object.entries(s.headers).forEach(([d,m])=>{d&&d.trim()!==""&&m&&m.trim()!==""&&(t[d.trim()]=m.trim())});const r={};s.name!==i.name&&(r.name=s.name),s.url!==i.url&&(r.url=s.url),s.method!==i.method&&(r.method=s.method),JSON.stringify(t)!==JSON.stringify(i.headers)&&(r.headers=t),s.timeout!==i.timeout&&(r.timeout=s.timeout),s.retry!==i.retry&&(r.retry=s.retry),JSON.stringify(s.events)!==JSON.stringify(i.events)&&(r.events=s.events),s.on!==i.on&&(r.on=s.on),(await Te(i.id,r)).code===200&&(j.success({description:"更新Webhook配置成功"}),u(!1),H())}catch(t){j.danger({description:"更新Webhook配置失败"}),console.error(t)}},ue=async()=>{try{(await Ee(i.id)).code===200&&(j.success({description:"删除Webhook配置成功"}),u(!1),H())}catch(t){j.danger({description:"删除Webhook配置失败"}),console.error(t)}},L=l.useCallback((t,r)=>{a(o=>{const d={...o.headers};return r===""||r.trim()===""?delete d[t]:d[t]=r.trim(),{...o,headers:d}})},[]),xe=l.useCallback(()=>{a(t=>{let r=1,o=`header_${r}`;for(;Object.prototype.hasOwnProperty.call(t.headers,o);)r++,o=`header_${r}`;const d={...t.headers,[o]:""};return{...t,headers:d}})},[]),he=l.useCallback((t,r,o)=>{if(!r||r.trim()===""||r===t)return;const d=r.trim();if(Object.keys(s.headers).some(O=>O!==t&&O===d))return;const m={...s.headers};delete m[t],m[d]=o,a(O=>({...O,headers:m}))},[s.headers]),fe=(t,r,o)=>{const d=setTimeout(()=>{he(t,r,o)},300);b(m=>(m[t]&&clearTimeout(m[t]),{...m,[t]:d}))},pe=t=>{const r=s.events.includes(t)?s.events.filter(o=>o!==t):[...s.events,t];a({...s,events:r})},be=l.useMemo(()=>Object.entries(s.headers).map(([t,r])=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"text",defaultValue:t,onBlur:o=>fe(t,o.target.value,r),className:"flex-1 px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Header名称"}),e.jsx("input",{type:"text",value:r,onChange:o=>L(t,o.target.value),className:"flex-1 px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Header值"}),e.jsx(k,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>L(t,""),children:e.jsx(X,{size:18})})]},t)),[s.headers,L]),je=()=>h==="delete"?e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-neutral-300 mb-4",children:["确定要删除 Webhook 配置 ",e.jsx("span",{className:"font-semibold text-red-400",children:i==null?void 0:i.name})," 吗？"]}),e.jsx("p",{className:"text-neutral-400 text-sm",children:"此操作不可撤销。"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"名称 *"}),e.jsx("input",{type:"text",required:!0,value:s.name,onChange:t=>a({...s,name:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"标识名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"HTTP方法 *"}),e.jsxs("select",{value:s.method,onChange:t=>a({...s,method:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"GET",children:"GET"}),e.jsx("option",{value:"POST",children:"POST"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"URL *"}),e.jsx("input",{type:"url",required:!0,value:s.url,onChange:t=>a({...s,url:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"https://example.com/webhook"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"超时时间(秒)"}),e.jsx("input",{type:"number",value:s.timeout,onChange:t=>a({...s,timeout:parseInt(t.target.value)}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",max:"300"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"重试次数"}),e.jsx("input",{type:"number",value:s.retry,onChange:t=>a({...s,retry:parseInt(t.target.value)}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0",max:"10"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium",children:"请求头"}),e.jsx(k,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(Q,{size:16}),onClick:xe,children:"添加请求头"})]}),e.jsx("div",{className:"space-y-2",children:be})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"监听事件"}),e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3 max-h-40 overflow-y-auto",children:D.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-2",children:D.map(t=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:s.events.includes(t),onChange:()=>pe(t),className:"text-blue-500"}),e.jsx("span",{className:"text-neutral-300 text-sm",children:t})]},t))}):e.jsx("p",{className:"text-neutral-500 text-sm",children:"暂无可用事件"})}),e.jsx("p",{className:"text-neutral-400 text-xs mt-1",children:"不选择任何事件表示监听所有事件"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"on",checked:s.on,onChange:t=>a({...s,on:t.target.checked}),className:"mr-2"}),e.jsx("label",{htmlFor:"on",className:"text-neutral-300",children:"启用此Webhook配置"})]})]}),ge=()=>f?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"Webhook"}),e.jsx("div",{className:"text-neutral-50",children:f.webhook})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"事件"}),e.jsx("div",{className:"text-neutral-50",children:f.event})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"状态"}),e.jsx("div",{children:f.success?e.jsx("span",{className:"text-green-400",children:"成功"}):e.jsx("span",{className:"text-red-400",children:"失败"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"响应码"}),e.jsx("div",{className:"text-neutral-50",children:f.resp||"-"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"耗时"}),e.jsx("div",{className:"text-neutral-50",children:f.duration?`${f.duration}ms`:"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"重试次数"}),e.jsx("div",{className:"text-neutral-50",children:f.retry})]})]}),f.error&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"错误信息"}),e.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:e.jsx("pre",{className:"text-red-300 text-sm whitespace-pre-wrap font-mono",children:f.error})})]})]}):null,Ne=()=>e.jsxs(e.Fragment,{children:[e.jsx($,{onClick:()=>u(!1),children:"取消"}),e.jsx($,{variant:h==="delete"?"danger":"primary",onClick:h==="create"?de:h==="edit"?me:ue,children:h==="create"?"创建":h==="edit"?"保存":"删除"})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full max-w-[1200px] mx-auto mb-6",children:e.jsxs("div",{className:"flex border-b border-neutral-700",children:[e.jsx("button",{className:`px-6 py-3 text-sm font-medium transition-colors ${y==="webhook"?"text-blue-400 border-b-2 border-blue-400":"text-neutral-400 hover:text-neutral-300"}`,onClick:()=>A("webhook"),children:"Webhook 配置"}),e.jsx("button",{className:`px-6 py-3 text-sm font-medium transition-colors ${y==="history"?"text-blue-400 border-b-2 border-blue-400":"text-neutral-400 hover:text-neutral-300"}`,onClick:ce,children:"调用历史"})]})}),y==="webhook"&&e.jsx(Ie,{webhooks:n,totalCount:w,currentPage:N,pageSize:10,loading:!1,onPageChange:W,onCreateWebhook:le,onEditWebhook:_,onDeleteWebhook:ne,onViewHistory:ie,onWebhookClick:oe}),y==="history"&&e.jsx(ze,{webhookHistory:I,totalCount:K,currentPage:E,pageSize:20,loading:!1,onPageChange:z,onViewDetail:G,onHistoryClick:G,webhookName:S?(F=n.find(t=>t.id===S))==null?void 0:F.name:null}),e.jsx(R,{isOpen:v,onClose:()=>u(!1),title:h==="create"?"创建 Webhook 配置":h==="edit"?"编辑 Webhook 配置":"删除 Webhook 配置",size:h!=="delete"?"lg":"sm",footer:Ne(),children:je()}),e.jsx(R,{isOpen:te,onClose:()=>M(!1),title:"Webhook 调用详情",size:"lg",footer:e.jsx($,{onClick:()=>M(!1),children:"关闭"}),children:ge()})]})}export{Je as default};
