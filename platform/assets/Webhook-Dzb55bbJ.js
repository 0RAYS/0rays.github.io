import{c as G,r as w,j as e,m as R,B as C,a as r,t as j}from"./index-BBMUkGmi.js";import{A as B,L as H}from"./AdminList-D2GhVz0F.js";import{A as J}from"./AdminPagination-D4-iUx_J.js";import{I as q}from"./IconPlus-CHXkvznM.js";import{I as ye}from"./IconEdit-DMtzJPEw.js";import{I as Q}from"./IconTrash-PGXHqy21.js";import{I as ke}from"./IconEye-DZlPd8wq.js";import{A as F,M as L}from"./AdminModal-CEXvjNqo.js";import"./IconChevronsRight-BNaHSBQK.js";import"./IconX-BvF2DaKv.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M12 8l0 4l2 2",key:"svg-0"}],["path",{d:"M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5",key:"svg-1"}]],we=G("outline","history","History",Ce);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=[["path",{d:"M4.876 13.61a4 4 0 1 0 6.124 3.39h6",key:"svg-0"}],["path",{d:"M15.066 20.502a4 4 0 1 0 1.934 -7.502c-.706 0 -1.424 .179 -2 .5l-3 -5.5",key:"svg-1"}],["path",{d:"M16 8a4 4 0 1 0 -8 0c0 1.506 .77 2.818 2 3.5l-3 5.5",key:"svg-2"}]],X=G("outline","webhook","Webhook",We),Se=(o={limit:10,offset:0})=>w({url:"/admin/webhook",method:"GET",params:o}),Te=o=>w({url:"/admin/webhook",method:"POST",data:o}),Ee=(o,b)=>w({url:`/admin/webhook/${o}`,method:"PUT",data:b}),He=o=>w({url:`/admin/webhook/${o}`,method:"DELETE"}),Oe=(o={limit:10,offset:0})=>w({url:"/admin/webhook/history",method:"GET",params:o}),Pe=()=>w({url:"/admin/webhook/events",method:"GET"});function Ie({webhooks:o=[],totalCount:b=0,currentPage:W=1,pageSize:g=10,loading:v=!1,onPageChange:S,onCreateWebhook:h,onEditWebhook:N,onDeleteWebhook:m,onViewHistory:l,onWebhookClick:n}){const x=[{key:"id",label:"ID",width:"5%"},{key:"name",label:"名称",width:"15%"},{key:"url",label:"URL",width:"20%"},{key:"method",label:"方法",width:"8%"},{key:"status",label:"状态",width:"10%"},{key:"events",label:"事件",width:"15%"},{key:"success",label:"成功次数",width:"10%"},{key:"failure",label:"失败次数",width:"10%"},{key:"actions",label:"操作",width:"7%"}],y=(s,u)=>{switch(u.key){case"id":return e.jsx("div",{className:"flex flex-col",children:e.jsxs("span",{className:"text-neutral-50 font-medium",children:["#",s.id]})});case"name":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:s.name})});case"url":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 font-mono text-sm truncate max-w-48",title:s.url,children:s.url})});case"method":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:`text-sm font-mono px-2 py-1 rounded ${s.method==="GET"?"bg-blue-400/20 text-blue-400":s.method==="POST"?"bg-green-400/20 text-green-400":s.method==="PUT"?"bg-yellow-400/20 text-yellow-400":s.method==="DELETE"?"bg-red-400/20 text-red-400":"bg-neutral-400/20 text-neutral-400"}`,children:s.method})});case"status":return e.jsx("div",{className:"flex flex-wrap gap-2",children:s.on?e.jsx(H,{type:"success",text:"已启用"}):e.jsx(H,{type:"warning",text:"已禁用"})});case"events":return e.jsx("div",{className:"flex flex-col",children:s.events&&s.events.length>0?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.events.slice(0,2).map((f,O)=>e.jsx("span",{className:"text-xs bg-neutral-700 text-neutral-300 px-1 py-0.5 rounded",children:f},O)),s.events.length>2&&e.jsxs("span",{className:"text-xs text-neutral-400",children:["+",s.events.length-2]})]}):e.jsx("span",{className:"text-neutral-500 text-sm",children:"全部事件"})});case"success":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-green-400 font-medium",children:s.success||0}),s.success_last&&e.jsx("span",{className:"text-xs text-neutral-400",children:new Date(s.success_last).toLocaleString()})]});case"failure":return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-red-400 font-medium",children:s.failure||0}),s.failure_last&&e.jsx("span",{className:"text-xs text-neutral-400",children:new Date(s.failure_last).toLocaleString()})]});case"actions":return e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),N==null||N(s)},className:"p-1",title:"编辑",children:e.jsx(ye,{size:16})}),e.jsx(C,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),l==null||l(s)},className:"p-1",title:"查看历史",children:e.jsx(we,{size:16})}),e.jsx(C,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),m==null||m(s)},className:"p-1 text-red-400 hover:text-red-300",title:"删除",children:e.jsx(Q,{size:16})})]});default:return null}};return e.jsx("div",{className:"w-full max-w-[1200px] mx-auto",children:e.jsxs(R.div,{className:"rounded-md bg-black/30 backdrop-blur-[2px] overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{size:24,className:"text-neutral-50"}),e.jsx("h1",{className:"text-3xl font-mono text-neutral-50",children:"Webhook 管理"})]}),e.jsx(C,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(q,{size:16}),onClick:h,children:"添加 Webhook 配置"})]}),e.jsx(B,{data:o,columns:x,renderCell:y,onRowClick:n,loading:v,empty:o.length===0,emptyContent:"暂无 Webhook 配置"}),b>g&&e.jsx(J,{currentPage:W,totalCount:b,pageSize:g,onPageChange:S})]})})}function ze({webhookHistory:o=[],totalCount:b=0,currentPage:W=1,pageSize:g=10,loading:v=!1,onPageChange:S,onViewDetail:h,onHistoryClick:N}){const m=[{key:"id",label:"ID",width:"5%"},{key:"webhook",label:"Webhook",width:"15%"},{key:"event",label:"事件",width:"15%"},{key:"status",label:"状态",width:"10%"},{key:"resp",label:"响应码",width:"10%"},{key:"duration",label:"耗时",width:"10%"},{key:"time",label:"调用时间",width:"12%"},{key:"actions",label:"操作",width:"5%"}],l=(n,x)=>{switch(x.key){case"id":return e.jsx("div",{className:"flex flex-col",children:e.jsxs("span",{className:"text-neutral-50 font-medium",children:["#",n.id]})});case"webhook":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:n.webhook})});case"event":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-50 font-medium",children:n.event})});case"status":return e.jsx("div",{className:"flex flex-wrap gap-2",children:n.success?e.jsx(H,{type:"success",text:"成功"}):e.jsx(H,{type:"error",text:"失败"})});case"resp":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:`text-sm font-mono ${n.resp>=200&&n.resp<300?"text-green-400":n.resp>=400&&n.resp<500?"text-yellow-400":n.resp>=500?"text-red-400":"text-neutral-400"}`,children:n.resp||"-"})});case"duration":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 text-sm",children:n.duration?`${n.duration}ms`:"-"})});case"time":return e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-neutral-300 text-sm",children:new Date(n.time).toLocaleString()})});case"actions":return e.jsx("div",{className:"flex gap-2",children:e.jsx(C,{variant:"ghost",size:"sm",onClick:y=>{y.stopPropagation(),h==null||h(n)},className:"p-1",title:"查看详情",children:e.jsx(ke,{size:16})})});default:return null}};return e.jsx("div",{className:"w-full max-w-[1200px] mx-auto",children:e.jsxs(R.div,{className:"rounded-md bg-black/30 backdrop-blur-[2px] overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{size:24,className:"text-neutral-50"}),e.jsx("h1",{className:"text-3xl font-mono text-neutral-50",children:"Webhook 调用历史"})]})}),e.jsx(B,{data:o,columns:m,renderCell:l,onRowClick:N,loading:v,empty:o.length===0,emptyContent:"暂无 Webhook 调用记录"}),b>g&&e.jsx(J,{currentPage:W,totalCount:b,pageSize:g,onPageChange:S})]})})}function Be(){const[o,b]=r.useState([]),[W,g]=r.useState(0),[v,S]=r.useState(1),h=10,[N,m]=r.useState(!1),[l,n]=r.useState(null),[x,y]=r.useState("edit"),[s,u]=r.useState({name:"",url:"",method:"POST",headers:{},timeout:0,retry:0,events:[],on:!1}),[f,O]=r.useState({}),[Y,Z]=r.useState([]),[K,V]=r.useState(0),[P,I]=r.useState(1),[p,ee]=r.useState(null),[te,z]=r.useState(!1),[k,M]=r.useState("webhook"),[se,$]=r.useState(null),[_,ae]=r.useState([]);r.useEffect(()=>{k==="webhook"?T():k==="history"&&ne()},[v,P,k,se]),r.useEffect(()=>{re()},[]),r.useEffect(()=>()=>{Object.values(f).forEach(t=>{t&&clearTimeout(t)})},[f]);const re=async()=>{try{const t=await Pe();t.code===200&&ae(t.data||[])}catch(t){console.error("获取事件列表失败:",t)}},T=async()=>{try{const t=await Se({limit:h,offset:(v-1)*h});t.code===200&&(b(t.data.webhooks||t.data),g(t.data.count||t.data.length))}catch(t){j.danger({description:"获取Webhook配置列表失败"}),console.error(t)}},ne=async()=>{try{const t=await Oe({limit:h,offset:(P-1)*h});t.code===200&&(Z(t.data.histories||t.data),V(t.data.count||t.data.length))}catch(t){j.danger({description:"获取Webhook历史记录失败"}),console.error(t)}},le=()=>{y("create"),n(null),u({name:"",url:"",method:"POST",headers:{},timeout:0,retry:0,events:[],on:!1}),m(!0)},U=t=>{y("edit"),n(t),u({name:t.name,url:t.url,method:t.method,headers:t.headers||{},timeout:t.timeout,retry:t.retry,events:t.events||[],on:t.on}),m(!0)},ce=t=>{y("delete"),n(t),m(!0)},ie=t=>{$(t.id),M("history"),I(1)},oe=()=>{$(null),M("history"),I(1)},de=t=>{U(t)},D=t=>{ee(t),z(!0)},me=async()=>{try{const t={};Object.entries(s.headers).forEach(([i,d])=>{i&&i.trim()!==""&&d&&d.trim()!==""&&(t[i.trim()]=d.trim())});const a={...s,headers:t};(await Te(a)).code===200&&(j.success({description:"创建Webhook配置成功"}),m(!1),T())}catch(t){j.danger({description:"创建Webhook配置失败"}),console.error(t)}},ue=async()=>{try{const t={};Object.entries(s.headers).forEach(([i,d])=>{i&&i.trim()!==""&&d&&d.trim()!==""&&(t[i.trim()]=d.trim())});const a={};s.name!==l.name&&(a.name=s.name),s.url!==l.url&&(a.url=s.url),s.method!==l.method&&(a.method=s.method),JSON.stringify(t)!==JSON.stringify(l.headers)&&(a.headers=t),s.timeout!==l.timeout&&(a.timeout=s.timeout),s.retry!==l.retry&&(a.retry=s.retry),JSON.stringify(s.events)!==JSON.stringify(l.events)&&(a.events=s.events),s.on!==l.on&&(a.on=s.on),(await Ee(l.id,a)).code===200&&(j.success({description:"更新Webhook配置成功"}),m(!1),T())}catch(t){j.danger({description:"更新Webhook配置失败"}),console.error(t)}},xe=async()=>{try{(await He(l.id)).code===200&&(j.success({description:"删除Webhook配置成功"}),m(!1),T())}catch(t){j.danger({description:"删除Webhook配置失败"}),console.error(t)}},A=r.useCallback((t,a)=>{u(c=>{const i={...c.headers};return a===""||a.trim()===""?delete i[t]:i[t]=a.trim(),{...c,headers:i}})},[]),he=r.useCallback(()=>{u(t=>{let a=1,c=`header_${a}`;for(;Object.prototype.hasOwnProperty.call(t.headers,c);)a++,c=`header_${a}`;const i={...t.headers,[c]:""};return{...t,headers:i}})},[]),fe=r.useCallback((t,a,c)=>{if(!a||a.trim()===""||a===t)return;const i=a.trim();if(Object.keys(s.headers).some(E=>E!==t&&E===i))return;const d={...s.headers};delete d[t],d[i]=c,u(E=>({...E,headers:d}))},[s.headers]),pe=(t,a,c)=>{const i=setTimeout(()=>{fe(t,a,c)},300);O(d=>(d[t]&&clearTimeout(d[t]),{...d,[t]:i}))},be=t=>{const a=s.events.includes(t)?s.events.filter(c=>c!==t):[...s.events,t];u({...s,events:a})},je=r.useMemo(()=>Object.entries(s.headers).map(([t,a])=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"text",defaultValue:t,onBlur:c=>pe(t,c.target.value,a),className:"flex-1 px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Header名称"}),e.jsx("input",{type:"text",value:a,onChange:c=>A(t,c.target.value),className:"flex-1 px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Header值"}),e.jsx(C,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>A(t,""),children:e.jsx(Q,{size:18})})]},t)),[s.headers,A]),ge=()=>x==="delete"?e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-neutral-300 mb-4",children:["确定要删除 Webhook 配置 ",e.jsx("span",{className:"font-semibold text-red-400",children:l==null?void 0:l.name})," 吗？"]}),e.jsx("p",{className:"text-neutral-400 text-sm",children:"此操作不可撤销。"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"名称 *"}),e.jsx("input",{type:"text",required:!0,value:s.name,onChange:t=>u({...s,name:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"标识名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"HTTP方法 *"}),e.jsxs("select",{value:s.method,onChange:t=>u({...s,method:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"GET",children:"GET"}),e.jsx("option",{value:"POST",children:"POST"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"URL *"}),e.jsx("input",{type:"url",required:!0,value:s.url,onChange:t=>u({...s,url:t.target.value}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"https://example.com/webhook"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"超时时间(秒)"}),e.jsx("input",{type:"number",value:s.timeout,onChange:t=>u({...s,timeout:parseInt(t.target.value)}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",min:"1",max:"300"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"重试次数"}),e.jsx("input",{type:"number",value:s.retry,onChange:t=>u({...s,retry:parseInt(t.target.value)}),className:"w-full px-3 py-1.5 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 focus:outline-none focus:ring-2 focus:ring-blue-500",min:"0",max:"10"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium",children:"请求头"}),e.jsx(C,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(q,{size:16}),onClick:he,children:"添加请求头"})]}),e.jsx("div",{className:"space-y-2",children:je})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"监听事件"}),e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3 max-h-40 overflow-y-auto",children:_.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-2",children:_.map(t=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:s.events.includes(t),onChange:()=>be(t),className:"text-blue-500"}),e.jsx("span",{className:"text-neutral-300 text-sm",children:t})]},t))}):e.jsx("p",{className:"text-neutral-500 text-sm",children:"暂无可用事件"})}),e.jsx("p",{className:"text-neutral-400 text-xs mt-1",children:"不选择任何事件表示监听所有事件"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"on",checked:s.on,onChange:t=>u({...s,on:t.target.checked}),className:"mr-2"}),e.jsx("label",{htmlFor:"on",className:"text-neutral-300",children:"启用此Webhook配置"})]})]}),ve=()=>p?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"Webhook"}),e.jsx("div",{className:"text-neutral-50",children:p.webhook})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"事件"}),e.jsx("div",{className:"text-neutral-50",children:p.event})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"状态"}),e.jsx("div",{children:p.success?e.jsx("span",{className:"text-green-400",children:"成功"}):e.jsx("span",{className:"text-red-400",children:"失败"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"响应码"}),e.jsx("div",{className:"text-neutral-50",children:p.resp||"-"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"耗时"}),e.jsx("div",{className:"text-neutral-50",children:p.duration?`${p.duration}ms`:"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"重试次数"}),e.jsx("div",{className:"text-neutral-50",children:p.retry})]})]}),p.error&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 text-sm font-medium mb-2",children:"错误信息"}),e.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3",children:e.jsx("pre",{className:"text-red-300 text-sm whitespace-pre-wrap font-mono",children:p.error})})]})]}):null,Ne=()=>e.jsxs(e.Fragment,{children:[e.jsx(L,{onClick:()=>m(!1),children:"取消"}),e.jsx(L,{variant:x==="delete"?"danger":"primary",onClick:x==="create"?me:x==="edit"?ue:xe,children:x==="create"?"创建":x==="edit"?"保存":"删除"})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full max-w-[1200px] mx-auto mb-6",children:e.jsxs("div",{className:"flex border-b border-neutral-700",children:[e.jsx("button",{className:`px-6 py-3 text-sm font-medium transition-colors ${k==="webhook"?"text-blue-400 border-b-2 border-blue-400":"text-neutral-400 hover:text-neutral-300"}`,onClick:()=>M("webhook"),children:"Webhook 配置"}),e.jsx("button",{className:`px-6 py-3 text-sm font-medium transition-colors ${k==="history"?"text-blue-400 border-b-2 border-blue-400":"text-neutral-400 hover:text-neutral-300"}`,onClick:oe,children:"调用历史"})]})}),k==="webhook"&&e.jsx(Ie,{webhooks:o,totalCount:W,currentPage:v,pageSize:h,loading:!1,onPageChange:S,onCreateWebhook:le,onEditWebhook:U,onDeleteWebhook:ce,onViewHistory:ie,onWebhookClick:de}),k==="history"&&e.jsx(ze,{webhookHistory:Y,totalCount:K,currentPage:P,pageSize:h,loading:!1,onPageChange:I,onViewDetail:D,onHistoryClick:D}),e.jsx(F,{isOpen:N,onClose:()=>m(!1),title:x==="create"?"创建 Webhook 配置":x==="edit"?"编辑 Webhook 配置":"删除 Webhook 配置",size:x!=="delete"?"lg":"sm",footer:Ne(),children:ge()}),e.jsx(F,{isOpen:te,onClose:()=>z(!1),title:"Webhook 调用详情",size:"lg",footer:e.jsx(L,{onClick:()=>z(!1),children:"关闭"}),children:ve()})]})}export{Be as default};
