import{c as H,a as x,j as e,m as h,B as u,h as ee,u as te,L as ae,t as T}from"./index-3olWmlYE.js";import{a as se,u as re,b as ne}from"./contest-B1aSRHnb.js";import{I as ie}from"./IconUpload-Z6WOtHjv.js";import{I as F}from"./IconPlus-CVyWF2p2.js";import{I as le}from"./IconEdit-DkdEPguq.js";import{I as O}from"./IconTrash-BdDqTvDz.js";import{I as oe}from"./IconX-CYhEXdWn.js";import{I as ce}from"./IconDeviceFloppy-BsUjOnON.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-0"}],["path",{d:"M12 9v4",key:"svg-1"}],["path",{d:"M12 16v.01",key:"svg-2"}]],C=H("outline","exclamation-circle","ExclamationCircle",de);/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"M15 8h.01",key:"svg-0"}],["path",{d:"M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z",key:"svg-1"}],["path",{d:"M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5",key:"svg-2"}],["path",{d:"M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3",key:"svg-3"}]],ue=H("outline","photo","Photo",me);function xe({contest:b,onSave:I,onCancel:N,onImageUpload:k}){var P,B,q;const[l,c]=x.useState(b||{title:"",description:"",image:"",status:"upcoming",startTime:"",endTime:"",participants:0,rules:[],prizes:[],timeline:[],_originalData:{prefix:"CTFHUB",size:4,hidden:!1,captcha:"",blood:!0}}),[f,j]=x.useState(""),[v,y]=x.useState(""),[S,z]=x.useState({rule:null,prize:null,timeline:null}),[d,p]=x.useState({}),[i,r]=x.useState(l.image||""),g=x.useRef(null),o="w-full bg-black/70 border-2 border-neutral-600 rounded-md p-3 text-neutral-50 font-mono focus:border-geek-400 focus:outline-none transition-colors duration-200",_=`${o} min-h-[100px] resize-none`,A="select-custom select-custom-md",$=a=>{if(!a)return"";try{const t=new Date(a);if(isNaN(t.getTime()))return"";const s=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),m=String(t.getDate()).padStart(2,"0"),D=String(t.getHours()).padStart(2,"0"),R=String(t.getMinutes()).padStart(2,"0");return`${s}-${n}-${m}T${D}:${R}`}catch(t){return console.error("日期转换错误:",t),""}},L=a=>{var s;const t=(s=a.target.files)==null?void 0:s[0];if(t){if(k)k(t).then(n=>{n&&(c(m=>({...m,image:n})),r(n))}).catch(n=>{console.error("图片上传失败:",n)});else{const n=new FileReader;n.onload=m=>{const D=m.target.result;c(R=>({...R,image:D})),r(D)},n.readAsDataURL(t)}a.target.value=""}},U=()=>{var a;(a=g.current)==null||a.click()},w=a=>{const{name:t,value:s}=a.target;if(t==="startTime"||t==="endTime")if(s)try{const n=new Date(s);isNaN(n.getTime())?(console.error("无效的日期格式:",s),p(m=>({...m,[t]:"无效的日期格式"}))):(c(m=>({...m,[t]:n.toISOString()})),d[t]&&p(m=>({...m,[t]:""})))}catch(n){console.error("日期处理错误:",n),p(m=>({...m,[t]:"日期处理错误"}))}else c(n=>({...n,[t]:""}));else c(n=>({...n,[t]:s})),d[t]&&p(n=>({...n,[t]:""}))},V=()=>{f.trim()&&(c(a=>({...a,rules:[...a.rules||[],f]})),j(""))},X=(a,t)=>{const s=[...l.rules];s[a]=t,c(n=>({...n,rules:s})),z(n=>({...n,rule:null})),y("")},Y=a=>{const t=l.rules.filter((s,n)=>n!==a);c(s=>({...s,rules:t}))},G=()=>{c(a=>({...a,prizes:[...a.prizes||[],{amount:"$0",desc:""}]}))},M=(a,t,s)=>{const n=[...l.prizes];n[a]={...n[a],[t]:s},c(m=>({...m,prizes:n}))},J=a=>{const t=l.prizes.filter((s,n)=>n!==a);c(s=>({...s,prizes:t}))},K=()=>{c(a=>({...a,timeline:[...a.timeline||[],{date:"",title:"",description:""}]}))},E=(a,t,s)=>{const n=[...l.timeline];n[a]={...n[a],[t]:s},c(m=>({...m,timeline:n}))},Q=a=>{const t=l.timeline.filter((s,n)=>n!==a);c(s=>({...s,timeline:t}))},W=()=>{const a={};return l.title.trim()||(a.title="标题不能为空"),l.description.trim()||(a.description="描述不能为空"),l.startTime||(a.startTime="请选择开始时间"),l.endTime?new Date(l.startTime)>=new Date(l.endTime)&&(a.endTime="结束时间必须晚于开始时间"):a.endTime="请选择结束时间",p(a),Object.keys(a).length===0},Z=a=>{var t;if(a.preventDefault(),W())I(l);else{const s=Object.keys(d)[0];s&&((t=document.getElementsByName(s)[0])==null||t.scrollIntoView({behavior:"smooth",block:"center"}))}};return e.jsxs("form",{onSubmit:Z,className:"w-full max-w-[1200px] mx-auto space-y-6",children:[e.jsxs(h.div,{className:"relative w-full border-2 border-neutral-300 rounded-md overflow-hidden bg-black/50 backdrop-blur-[2px] p-8",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"比赛标题"}),e.jsx("input",{type:"text",name:"title",value:l.title,onChange:w,className:`${o} ${d.title?"border-red-400":""}`,required:!0}),d.title&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(C,{size:16}),d.title]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"描述"}),e.jsx("textarea",{name:"description",value:l.description,onChange:w,className:`${_} ${d.description?"border-red-400":""}`}),d.description&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(C,{size:16}),d.description]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"背景图片"}),e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{className:"flex-1",onClick:U,children:[e.jsx("div",{className:"w-full h-[200px] border-2 border-dashed border-neutral-600 rounded-md bg-black/30 flex items-center justify-center overflow-hidden relative group",children:i?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:i,alt:"比赛背景",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx(u,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(ie,{size:16}),children:"更换图片"})})]}):e.jsx(u,{variant:"ghost",size:"sm",align:"icon-left",icon:e.jsx(ue,{size:48}),className:"flex-col !gap-3 !text-neutral-400",children:"点击上传背景图片"})}),e.jsx("input",{ref:g,type:"file",accept:"image/*",className:"hidden",onChange:L})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"状态"}),e.jsxs("select",{name:"status",value:l.status,className:A,disabled:!0,children:[e.jsx("option",{value:"upcoming",children:"即将开始"}),e.jsx("option",{value:"active",children:"进行中"}),e.jsx("option",{value:"ended",children:"已结束"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"开始时间"}),e.jsx("input",{type:"datetime-local",name:"startTime",value:$(l.startTime),onChange:w,className:`${o} ${d.startTime?"border-red-400":""}`}),d.startTime&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(C,{size:16}),d.startTime]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"结束时间"}),e.jsx("input",{type:"datetime-local",name:"endTime",value:$(l.endTime),onChange:w,className:`${o} ${d.endTime?"border-red-400":""}`}),d.endTime&&e.jsxs("p",{className:"mt-2 text-red-400 text-sm flex items-center gap-1",children:[e.jsx(C,{size:16}),d.endTime]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-xl font-mono text-neutral-50 tracking-wider mb-4",children:"高级设置"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"Flag前缀"}),e.jsx("input",{type:"text",name:"_originalData.prefix",value:l._originalData.prefix,onChange:a=>c(t=>({...t,_originalData:{...t._originalData,prefix:a.target.value}})),className:o,placeholder:"例如: CBCTF"}),e.jsxs("p",{className:"mt-1 text-neutral-500 text-sm",children:["用于生成flag的前缀，例如：CBCTF","{flag}"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"团队人数上限"}),e.jsx("input",{type:"number",name:"_originalData.size",value:l._originalData.size,onChange:a=>c(t=>({...t,_originalData:{...t._originalData,size:parseInt(a.target.value)||1}})),min:"1",max:"10",className:o,placeholder:"团队最大人数"}),e.jsx("p",{className:"mt-1 text-neutral-500 text-sm",children:"每个参赛团队的最大人数"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2",children:"比赛验证码"}),e.jsx("input",{type:"text",name:"_originalData.captcha",value:l._originalData.captcha,onChange:a=>c(t=>({...t,_originalData:{...t._originalData,captcha:a.target.value}})),className:o,placeholder:"留空则不需要验证码"}),e.jsx("p",{className:"mt-1 text-neutral-500 text-sm",children:"加入比赛需要的验证码"})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"hidden-toggle",className:"w-5 h-5 bg-black border-2 border-neutral-600 rounded text-geek-400 focus:ring-geek-400",checked:l._originalData.hidden,onChange:a=>c(t=>({...t,_originalData:{...t._originalData,hidden:a.target.checked}}))}),e.jsx("label",{htmlFor:"hidden-toggle",className:"text-neutral-300 font-medium",children:"隐藏比赛"})]}),e.jsx("p",{className:"text-neutral-500 text-sm",children:"隐藏后比赛将无法访问"}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("input",{type:"checkbox",id:"blood-toggle",className:"w-5 h-5 bg-black border-2 border-neutral-600 rounded text-geek-400 focus:ring-geek-400",checked:l._originalData.blood,onChange:a=>c(t=>({...t,_originalData:{...t._originalData,blood:a.target.checked}}))}),e.jsx("label",{htmlFor:"blood-toggle",className:"text-neutral-300 font-medium",children:"启用血分奖励"})]}),e.jsx("p",{className:"text-neutral-500 text-sm",children:"对前三个解出题目的队伍提供额外加分"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(h.div,{className:"col-span-1 md:col-span-2 border-2 border-neutral-300 rounded-md bg-black/50 backdrop-blur-[2px] p-8",children:[e.jsx("h2",{className:"text-2xl font-mono text-neutral-50 tracking-wider mb-6",children:"比赛规则"}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx("input",{type:"text",value:f,onChange:a=>j(a.target.value),className:o,placeholder:"添加新规则..."}),e.jsx(u,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(F,{size:18}),onClick:V,children:"添加"})]}),e.jsx("div",{className:"space-y-4 text-neutral-300",children:(P=l.rules)==null?void 0:P.map((a,t)=>e.jsxs(h.div,{className:"flex items-center gap-4 p-2 rounded-md hover:bg-neutral-300/5 transition-colors duration-200",children:[e.jsx("span",{className:"text-geek-400 font-mono",children:(t+1).toString().padStart(2,"0")}),S.rule===t?e.jsx("input",{type:"text",value:v||a,onChange:s=>y(s.target.value),className:o,autoFocus:!0,onBlur:()=>X(t,v),required:!0}):e.jsx("p",{className:"flex-1",children:a}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"ghost",size:"icon",className:"!bg-transparent !text-geek-400 hover:!text-geek-300",onClick:()=>z(s=>({...s,rule:t})),children:e.jsx(le,{size:18})}),e.jsx(u,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>Y(t),children:e.jsx(O,{size:18})})]})]},t))})]}),e.jsxs(h.div,{className:"border-2 border-neutral-300 rounded-md bg-black/50 backdrop-blur-[2px] p-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-mono text-neutral-50 tracking-wider",children:"奖励设置"}),e.jsx(u,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(F,{size:16}),onClick:G,children:"添加奖励"})]}),e.jsx("div",{className:"space-y-6",children:(B=l.prizes)==null?void 0:B.map((a,t)=>e.jsxs(h.div,{className:"p-4 border border-neutral-700 rounded-md bg-black/30",whileHover:{scale:1.02},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("span",{className:`text-lg font-mono
                      ${t===0?"text-yellow-400":t===1?"text-neutral-300":t===2?"text-orange-400":"text-neutral-400"}
                    `,children:t===0?"1ST":t===1?"2ND":t===2?"3RD":`${t+1}TH`})}),e.jsx(u,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300",onClick:()=>J(t),children:e.jsx(O,{size:18})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"金额"}),e.jsx("input",{type:"text",value:a.amount,onChange:s=>M(t,"amount",s.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 font-mono focus:border-geek-400 focus:outline-none transition-colors duration-200",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"描述"}),e.jsx("textarea",{value:a.desc||"",onChange:s=>M(t,"desc",s.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 text-sm min-h-[60px] resize-none focus:border-geek-400 focus:outline-none transition-colors duration-200",required:!0})]})]})]},t))})]})]}),e.jsxs(h.div,{className:"border-2 border-neutral-300 rounded-md bg-black/50 backdrop-blur-[2px] p-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-2xl font-mono text-neutral-50 tracking-wider",children:"时间线"}),e.jsx(u,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(F,{size:16}),onClick:K,children:"添加事件"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:(q=l.timeline)==null?void 0:q.map((a,t)=>e.jsxs(h.div,{className:"p-4 border border-neutral-700 rounded-md bg-black/30 relative",whileHover:{y:-5},children:[e.jsx(u,{variant:"ghost",size:"icon",className:"!bg-transparent !text-red-400 hover:!text-red-300 absolute top-2 right-2",onClick:()=>Q(t),children:e.jsx(oe,{size:18})}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"日期"}),e.jsx("input",{type:"datetime-local",value:$(a.date),onChange:s=>E(t,"date",s.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 font-mono focus:border-geek-400 focus:outline-none transition-colors duration-200",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"标题"}),e.jsx("input",{type:"text",value:a.title,onChange:s=>E(t,"title",s.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 focus:border-geek-400 focus:outline-none transition-colors duration-200",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-neutral-300 font-medium mb-2 text-sm",children:"描述"}),e.jsx("textarea",{value:a.description,onChange:s=>E(t,"description",s.target.value),className:"w-full bg-black/70 border-2 border-neutral-600 rounded-md p-2 text-neutral-50 text-sm min-h-[60px] resize-none focus:border-geek-400 focus:outline-none transition-colors duration-200",required:!0})]})]})]},t))})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-8",children:[e.jsx(u,{variant:"ghost",size:"sm",onClick:N,children:"取消"}),e.jsx(u,{variant:"primary",size:"sm",align:"icon-left",icon:e.jsx(ce,{size:18}),type:"submit",children:"保存更改"})]})]})}function ke(){const{id:b}=ee(),I=te(),[N,k]=x.useState(null),[l,c]=x.useState(!0),[f,j]=x.useState("");x.useEffect(()=>{v()},[b]);const v=async()=>{var i;c(!0);try{const r=await se(parseInt(b));if(r.code===200){const g={title:r.data.name,description:r.data.desc,image:r.data.avatar,status:y(r.data),startTime:r.data.start,endTime:S(r.data.start,r.data.duration),participants:r.data.users,rules:r.data.rules||[],prizes:((i=r.data.prizes)==null?void 0:i.map(o=>({amount:o.amount,desc:o.desc})))||[],timeline:r.data.timelines?r.data.timelines.map(o=>({date:o.date,title:o.title,description:o.desc})):[],_originalData:{prefix:r.data.prefix,size:r.data.size,hidden:r.data.hidden,captcha:r.data.captcha,blood:r.data.blood}};k(g)}else j(r.msg||"获取比赛信息失败")}catch(r){j("获取比赛信息失败"),console.error(r)}finally{c(!1)}},y=i=>{const r=new Date().getTime()/1e3,g=new Date(i==null?void 0:i.start).getTime()/1e3,o=i==null?void 0:i.duration,_=g+o;return r<g?"upcoming":r>_?"ended":"active"},S=(i,r)=>{if(!i||!r)return"";const g=new Date(i);return new Date(g.getTime()+r*1e3).toISOString()},z=async i=>{try{const r=await re(b,i);if(r.code===200)return T.success({description:"更新比赛封面成功"}),r.data.avatar}catch(r){console.error("更新封面失败:",r),T.danger({description:"更新封面失败"})}return null},d=async i=>{try{const r={name:i.title,desc:i.description,prefix:i._originalData.prefix,size:i._originalData.size,hidden:i._originalData.hidden,captcha:i._originalData.captcha,blood:i._originalData.blood,start:new Date(i.startTime).toISOString(),duration:Math.floor((new Date(i.endTime)-new Date(i.startTime))/1e3),status:i.status,timelines:i.timeline.map(o=>({date:o.date?new Date(o.date).toISOString():"",title:o.title,desc:o.description})),rules:i.rules,prizes:i.prizes.map(o=>({amount:o.amount,desc:o.desc}))};(await ne(parseInt(b),r)).code===200&&(T.success({description:"更新比赛信息成功"}),await v())}catch(r){console.error("更新比赛信息失败:",r),T.danger({description:"更新比赛信息失败"})}},p=()=>{I("/admin/contests")};return l?e.jsx(ae,{}):f?e.jsx("div",{className:"text-red-500",children:f}):N?e.jsx(xe,{contest:N,onSave:d,onCancel:p,onImageUpload:z}):null}export{ke as default};
